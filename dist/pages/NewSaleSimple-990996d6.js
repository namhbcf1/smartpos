import{j as n,E as s,x as e,J as t,B as i,i as r,K as a,N as l,G as h,ad as c,y as o,z as d,e as x,l as u,H as m,Z as j,_ as g,$ as p,a0 as y,a1 as v,a2 as f,h as b,o as k,W as _,X as C,Y as S,n as q,a5 as T,a6 as I,a7 as W,a9 as w}from"../chunks/mui-core-c8a509c2.js";import{r as A}from"../chunks/react-vendor-546521e5.js";import{u as G,b as z,c as P}from"../chunks/query-vendor-a9f5ea8b.js";import{a as K}from"../chunks/ui-vendor-6aa703b7.js";import{a as R,f as $}from"../assets/index-e3f8a988.js";import{a as B,S as X,w as O,G as E,X as H,Y as M,Z as Q,O as U,_ as V}from"../chunks/mui-icons-38bddb39.js";import"../chunks/utils-vendor-11713830.js";const D=()=>{const{enqueueSnackbar:D}=K(),F=G(),[L,N]=A.useState([]),[Y,Z]=A.useState(""),[J,nn]=A.useState(null),[sn,en]=A.useState(1),[tn,rn]=A.useState({name:"",phone:"",email:"",address:""}),[an,ln]=A.useState("cash"),[hn,cn]=A.useState(0),[on,dn]=A.useState(""),[xn,un]=A.useState(!1),[mn,jn]=A.useState(!1),{data:gn=[],isLoading:pn}=z({queryKey:["products","search",Y],queryFn:async()=>{if(!Y||Y.length<2)return[];try{const n=await R.get("/products",{params:{search:Y,is_active:!0,limit:20}});return n&&Array.isArray(n.data)?n.data:n&&Array.isArray(n)?n:[]}catch(n){return[]}},enabled:Y.length>=2}),yn=P({mutationFn:async n=>await R.post("/sales",n),onSuccess:()=>{F.invalidateQueries({queryKey:["sales"]}),D("Đơn hàng đã được tạo thành công!",{variant:"success"})},onError:n=>{D(n.response?.data?.message||"Có lỗi xảy ra khi tạo đơn hàng",{variant:"error"})}}),vn=(n,s)=>{if(s<=0)return void fn(n);const e=L.find(s=>s.id===n);e&&s>e.product.stock_quantity?D(`Số lượng tồn kho không đủ. Chỉ còn ${e.product.stock_quantity} sản phẩm`,{variant:"error"}):N(L.map(e=>e.id===n?{...e,quantity:s,total_price:e.unit_price*s}:e))},fn=n=>{N(L.filter(s=>s.id!==n)),D("Đã xóa sản phẩm khỏi giỏ hàng",{variant:"info"})},bn=()=>{N([]),rn({name:"",phone:"",email:"",address:""}),cn(0),dn(""),ln("cash")},kn=L.reduce((n,s)=>n+s.total_price,0),_n=kn*hn/100,Cn=kn-_n,Sn=.1*Cn,qn={subtotal:kn,discountAmount:_n,taxAmount:Sn,total:Cn+Sn};return n.jsxs(s,{maxWidth:"xl",sx:{py:3},children:[n.jsx(e,{elevation:1,sx:{p:{xs:2,sm:3},mb:3,borderRadius:2,bgcolor:"white"},children:n.jsx(t,{direction:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",sm:"center"},spacing:2,children:n.jsxs(i,{children:[n.jsxs(r,{variant:"h4",sx:{display:"flex",alignItems:"center",gap:1,fontSize:{xs:"1.5rem",sm:"2rem",md:"2.125rem"},fontWeight:600,color:"primary.main",mb:1},children:[n.jsx(B,{sx:{fontSize:"inherit"}}),"Điểm bán hàng (POS)"]}),n.jsx(r,{variant:"body1",color:"text.secondary",sx:{fontSize:{xs:"0.875rem",sm:"1rem"}},children:"Tạo đơn hàng và thanh toán nhanh chóng"})]})})}),n.jsxs(i,{sx:{flexGrow:1,display:"grid",gridTemplateColumns:{xs:"1fr",md:"2fr 1fr"},gap:3,alignItems:"start",width:"100%"},children:[n.jsxs(i,{sx:{minWidth:0},children:[n.jsx(a,{sx:{mb:3,borderRadius:2},children:n.jsxs(l,{children:[n.jsx(r,{variant:"h6",gutterBottom:!0,children:"Tìm kiếm sản phẩm"}),n.jsxs(h,{container:!0,spacing:2,alignItems:"center",children:[n.jsx(h,{item:!0,xs:12,md:6,children:n.jsx(c,{options:gn,getOptionLabel:n=>`${n.name} (${n.sku})`,value:J,onChange:(n,s)=>nn(s),inputValue:Y,onInputChange:(n,s)=>Z(s),loading:pn,renderInput:s=>n.jsx(o,{...s,label:"Tìm sản phẩm theo tên hoặc SKU",variant:"outlined",fullWidth:!0,InputProps:{...s.InputProps,startAdornment:n.jsx(d,{position:"start",children:n.jsx(X,{})})}}),renderOption:(s,e)=>n.jsxs(i,{component:"li",...s,children:[n.jsx(x,{src:e.image_url||void 0,sx:{mr:2,width:40,height:40},children:e.name.charAt(0)}),n.jsxs(i,{children:[n.jsx(r,{variant:"body1",children:e.name}),n.jsxs(r,{variant:"body2",color:"text.secondary",children:["SKU: ",e.sku," | Giá: ",$(e.price)," | Tồn: ",e.stock_quantity]})]})]})})}),n.jsx(h,{item:!0,xs:12,md:3,children:n.jsx(o,{label:"Số lượng",type:"number",value:sn,onChange:n=>en(Math.max(1,parseInt(n.target.value)||1)),fullWidth:!0,inputProps:{min:1}})}),n.jsx(h,{item:!0,xs:12,md:3,children:n.jsx(u,{variant:"contained",color:"primary",fullWidth:!0,size:"large",startIcon:n.jsx(O,{}),onClick:()=>{if(!J||sn<=0)return void D("Vui lòng chọn sản phẩm và nhập số lượng hợp lệ",{variant:"error"});if(sn>J.stock_quantity)return void D(`Số lượng tồn kho không đủ. Chỉ còn ${J.stock_quantity} sản phẩm`,{variant:"error"});const n=L.findIndex(n=>n.product.id===J.id);if(n>=0){const s=[...L],e=s[n].quantity+sn;if(e>J.stock_quantity)return void D(`Số lượng tồn kho không đủ. Chỉ còn ${J.stock_quantity} sản phẩm`,{variant:"error"});s[n]={...s[n],quantity:e,total_price:J.price*e},N(s)}else{const n={id:Date.now(),product:J,quantity:sn,unit_price:J.price,total_price:J.price*sn};N([...L,n])}nn(null),Z(""),en(1),D("Đã thêm sản phẩm vào giỏ hàng",{variant:"success"})},disabled:!J,children:"Thêm vào giỏ"})})]}),J&&n.jsxs(m,{severity:"info",sx:{mt:2},children:[n.jsx("strong",{children:J.name}),n.jsx("br",{}),"Giá: ",$(J.price)," | Tồn kho: ",J.stock_quantity," | Danh mục: ",J.category_name]})]})}),n.jsx(a,{sx:{borderRadius:2},children:n.jsxs(l,{children:[n.jsxs(i,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[n.jsxs(r,{variant:"h6",children:["Giỏ hàng (",L.length," sản phẩm)"]}),L.length>0&&n.jsx(u,{variant:"outlined",size:"small",onClick:bn,startIcon:n.jsx(E,{}),children:"Xóa tất cả"})]}),0===L.length?n.jsxs(m,{severity:"info",sx:{display:"flex",alignItems:"center",gap:1},children:[n.jsx(B,{}),"Giỏ hàng trống. Hãy thêm sản phẩm vào giỏ hàng."]}):n.jsx(j,{component:e,children:n.jsxs(g,{children:[n.jsx(p,{children:n.jsxs(y,{children:[n.jsx(v,{children:"Sản phẩm"}),n.jsx(v,{align:"right",children:"Giá"}),n.jsx(v,{align:"center",children:"Số lượng"}),n.jsx(v,{align:"right",children:"Thành tiền"}),n.jsx(v,{align:"center",children:"Thao tác"})]})}),n.jsx(f,{children:L.map(s=>n.jsxs(y,{children:[n.jsx(v,{children:n.jsxs(i,{display:"flex",alignItems:"center",children:[n.jsx(x,{src:s.product.image_url||void 0,sx:{mr:2,width:32,height:32},children:s.product.name.charAt(0)}),n.jsxs(i,{children:[n.jsx(r,{variant:"body2",fontWeight:500,children:s.product.name}),n.jsxs(r,{variant:"caption",color:"text.secondary",children:["SKU: ",s.product.sku]})]})]})}),n.jsx(v,{align:"right",children:$(s.unit_price)}),n.jsx(v,{align:"center",children:n.jsxs(i,{display:"flex",alignItems:"center",justifyContent:"center",children:[n.jsx(b,{size:"small",onClick:()=>vn(s.id,s.quantity-1),children:n.jsx(H,{})}),n.jsx(r,{sx:{mx:1,minWidth:30,textAlign:"center"},children:s.quantity}),n.jsx(b,{size:"small",onClick:()=>vn(s.id,s.quantity+1),children:n.jsx(O,{})})]})}),n.jsx(v,{align:"right",children:$(s.total_price)}),n.jsx(v,{align:"center",children:n.jsx(b,{size:"small",color:"error",onClick:()=>fn(s.id),children:n.jsx(E,{})})})]},s.id))})]})})]})})]}),n.jsxs(i,{sx:{minWidth:0},children:[n.jsx(a,{sx:{mb:3,borderRadius:2},children:n.jsxs(l,{children:[n.jsxs(r,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[n.jsx(M,{}),"Thông tin khách hàng"]}),n.jsxs(h,{container:!0,spacing:2,children:[n.jsx(h,{item:!0,xs:12,children:n.jsx(o,{label:"Tên khách hàng",value:tn.name,onChange:n=>rn(s=>({...s,name:n.target.value})),fullWidth:!0,InputProps:{startAdornment:n.jsx(d,{position:"start",children:n.jsx(M,{})})}})}),n.jsx(h,{item:!0,xs:12,children:n.jsx(o,{label:"Số điện thoại",value:tn.phone,onChange:n=>rn(s=>({...s,phone:n.target.value})),fullWidth:!0,InputProps:{startAdornment:n.jsx(d,{position:"start",children:n.jsx(Q,{})})}})}),n.jsx(h,{item:!0,xs:12,children:n.jsx(o,{label:"Ghi chú",value:on,onChange:n=>dn(n.target.value),fullWidth:!0,multiline:!0,rows:2})})]})]})}),n.jsx(a,{sx:{borderRadius:2},children:n.jsxs(l,{children:[n.jsxs(r,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[n.jsx(U,{}),"Tổng kết đơn hàng"]}),n.jsxs(i,{sx:{mb:3},children:[n.jsxs(i,{display:"flex",justifyContent:"space-between",mb:1,children:[n.jsx(r,{children:"Tạm tính:"}),n.jsx(r,{children:$(qn.subtotal)})]}),n.jsxs(i,{display:"flex",justifyContent:"space-between",mb:1,children:[n.jsxs(r,{children:["Giảm giá (",hn,"%):"]}),n.jsxs(r,{color:"error",children:["-",$(qn.discountAmount)]})]}),n.jsxs(i,{display:"flex",justifyContent:"space-between",mb:1,children:[n.jsx(r,{children:"Thuế VAT (10%):"}),n.jsx(r,{children:$(qn.taxAmount)})]}),n.jsx(k,{sx:{my:1}}),n.jsxs(i,{display:"flex",justifyContent:"space-between",mb:2,children:[n.jsx(r,{variant:"h6",fontWeight:"bold",children:"Tổng cộng:"}),n.jsx(r,{variant:"h6",fontWeight:"bold",color:"primary",children:$(qn.total)})]}),n.jsxs(h,{container:!0,spacing:2,sx:{mb:2},children:[n.jsx(h,{item:!0,xs:12,children:n.jsxs(_,{fullWidth:!0,children:[n.jsx(C,{children:"Phương thức thanh toán"}),n.jsxs(S,{value:an,onChange:n=>ln(n.target.value),label:"Phương thức thanh toán",children:[n.jsx(q,{value:"cash",children:"Tiền mặt"}),n.jsx(q,{value:"card",children:"Thẻ"}),n.jsx(q,{value:"transfer",children:"Chuyển khoản"}),n.jsx(q,{value:"qr",children:"QR Code"})]})]})}),n.jsx(h,{item:!0,xs:12,children:n.jsx(o,{label:"Giảm giá (%)",type:"number",value:hn,onChange:n=>cn(Math.max(0,Math.min(100,Number(n.target.value)))),fullWidth:!0,inputProps:{min:0,max:100}})})]}),n.jsx(u,{variant:"contained",color:"primary",fullWidth:!0,size:"large",startIcon:n.jsx(V,{}),onClick:()=>un(!0),disabled:0===L.length||mn,children:"Thanh toán"})]})]})})]})]}),n.jsxs(T,{open:xn,onClose:()=>un(!1),maxWidth:"md",fullWidth:!0,children:[n.jsx(I,{children:n.jsxs(i,{display:"flex",alignItems:"center",children:[n.jsx(U,{sx:{mr:1}}),"Xác nhận thanh toán"]})}),n.jsxs(W,{children:[n.jsx(r,{variant:"h6",gutterBottom:!0,children:"Thông tin đơn hàng"}),n.jsxs(i,{sx:{mb:2},children:[n.jsxs(r,{children:[n.jsx("strong",{children:"Khách hàng:"})," ",tn.name||"Khách lẻ"]}),n.jsxs(r,{children:[n.jsx("strong",{children:"Số điện thoại:"})," ",tn.phone||"Không có"]}),n.jsxs(r,{children:[n.jsx("strong",{children:"Phương thức thanh toán:"})," ","cash"===an?"Tiền mặt":"card"===an?"Thẻ":"transfer"===an?"Chuyển khoản":"QR Code"]}),n.jsxs(r,{children:[n.jsx("strong",{children:"Tổng tiền:"})," ",$(qn.total)]})]})]}),n.jsxs(w,{children:[n.jsx(u,{onClick:()=>un(!1),children:"Hủy"}),n.jsx(u,{variant:"contained",onClick:()=>{if(0===L.length)return void D("Giỏ hàng trống",{variant:"error"});jn(!0);const n={customer_name:tn.name||null,customer_phone:tn.phone||null,customer_email:tn.email||null,payment_method:an,discount_amount:qn.discountAmount,tax_amount:qn.taxAmount,total_amount:qn.total,notes:on||null,items:L.map(n=>({product_id:n.product.id,quantity:n.quantity,unit_price:n.unit_price,total_price:n.total_price}))};yn.mutate(n,{onSuccess:()=>{bn(),un(!1),jn(!1)},onError:()=>{jn(!1)}})},disabled:mn,children:mn?"Đang xử lý...":"Xác nhận thanh toán"})]})]})]})};export{D as default};
