import{j as e,E as n,i as t,B as s,l as r,K as a,N as i,G as l,y as o,z as c,W as h,X as d,Y as x,n as u,m as j,h as g,H as m,Z as p,x as v,_ as y,$ as f,a0 as b,a1 as w,a2 as C,a4 as S,a5 as k,a6 as I,a7 as _,o as T,a9 as P,O as W}from"../chunks/mui-core-c8a509c2.js";import{u as L,r as z,L as $}from"../chunks/react-vendor-546521e5.js";import{u as H}from"../chunks/useApiData-43bfc734.js";import{a as B}from"../chunks/ui-vendor-6aa703b7.js";import{f as D}from"../assets/index-e3f8a988.js";import{a2 as N,w as A,S as E,p as G,F as K,o as R,E as O,$ as X,z as q,y as V,W as F}from"../chunks/mui-icons-38bddb39.js";import"../chunks/query-vendor-a9f5ea8b.js";import"../chunks/utils-vendor-11713830.js";const J=()=>{const J=L(),{enqueueSnackbar:M}=B(),[Q,U]=z.useState(""),[Y,Z]=z.useState(""),[ee,ne]=z.useState(""),[te,se]=z.useState(""),[re,ae]=z.useState({open:!1,returnItem:null,newStatus:"",notes:""}),ie=z.useMemo(()=>{const e={};return Q.trim()&&(e.search=Q.trim()),Y&&(e.return_status=Y),ee&&(e.date_from=ee),te&&(e.date_to=te),e},[Q,Y,ee,te]),{data:le,pagination:oe,isLoading:ce,error:he,refetch:de,handlePageChange:xe,handleLimitChange:ue,page:je,limit:ge}=H("/returns",ie),me=n=>{switch(n){case"pending":return e.jsx(W,{icon:e.jsx(F,{}),label:"Chờ duyệt",color:"warning",size:"small"});case"approved":return e.jsx(W,{icon:e.jsx(V,{}),label:"Đã duyệt",color:"success",size:"small"});case"rejected":return e.jsx(W,{icon:e.jsx(q,{}),label:"Từ chối",color:"error",size:"small"});case"completed":return e.jsx(W,{icon:e.jsx(X,{}),label:"Hoàn thành",color:"info",size:"small"});default:return e.jsx(W,{label:n,size:"small"})}};return e.jsxs(n,{maxWidth:"xl",sx:{py:3},children:[e.jsxs(t,{variant:"h4",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(N,{}),"Trả hàng & Hoàn tiền"]}),e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(t,{variant:"h6",color:"text.secondary",children:"Quản lý trả hàng và hoàn tiền"}),e.jsx(r,{variant:"contained",startIcon:e.jsx(A,{}),component:$,to:"/returns/new",children:"Tạo phiếu trả hàng"})]}),e.jsx(a,{sx:{mb:3},children:e.jsx(i,{children:e.jsxs(l,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(l,{item:!0,xs:12,md:3,children:e.jsx(o,{fullWidth:!0,label:"Tìm kiếm",placeholder:"Lý do trả hàng, tên khách hàng...",value:Q,onChange:e=>U(e.target.value),InputProps:{startAdornment:e.jsx(c,{position:"start",children:e.jsx(E,{})})}})}),e.jsx(l,{item:!0,xs:12,md:2,children:e.jsxs(h,{fullWidth:!0,children:[e.jsx(d,{children:"Trạng thái"}),e.jsxs(x,{value:Y,label:"Trạng thái",onChange:e=>Z(e.target.value),children:[e.jsx(u,{value:"",children:"Tất cả"}),e.jsx(u,{value:"pending",children:"Chờ duyệt"}),e.jsx(u,{value:"approved",children:"Đã duyệt"}),e.jsx(u,{value:"rejected",children:"Từ chối"}),e.jsx(u,{value:"completed",children:"Hoàn thành"})]})]})}),e.jsx(l,{item:!0,xs:12,md:2,children:e.jsx(o,{fullWidth:!0,type:"date",label:"Từ ngày",value:ee,onChange:e=>ne(e.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(l,{item:!0,xs:12,md:2,children:e.jsx(o,{fullWidth:!0,type:"date",label:"Đến ngày",value:te,onChange:e=>se(e.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(l,{item:!0,xs:12,md:3,children:e.jsxs(s,{sx:{display:"flex",gap:1},children:[e.jsx(j,{title:"Làm mới",children:e.jsx(g,{onClick:de,children:e.jsx(G,{})})}),e.jsx(j,{title:"Xóa bộ lọc",children:e.jsx(g,{onClick:()=>{U(""),Z(""),ne(""),se("")},children:e.jsx(K,{})})})]})})]})})}),he&&e.jsx(m,{severity:"error",sx:{mb:2},children:he}),e.jsxs(p,{component:v,children:[e.jsxs(y,{children:[e.jsx(f,{children:e.jsxs(b,{children:[e.jsx(w,{children:"ID"}),e.jsx(w,{children:"Đơn hàng gốc"}),e.jsx(w,{children:"Khách hàng"}),e.jsx(w,{align:"right",children:"Số tiền trả"}),e.jsx(w,{children:"Lý do"}),e.jsx(w,{children:"Trạng thái"}),e.jsx(w,{children:"Ngày tạo"}),e.jsx(w,{align:"center",children:"Thao tác"})]})}),e.jsx(C,{children:ce?Array.from({length:ge}).map((n,t)=>e.jsx(b,{children:e.jsx(w,{colSpan:8,children:e.jsx(s,{sx:{display:"flex",alignItems:"center",gap:2},children:e.jsx(s,{sx:{width:"100%",height:40,bgcolor:"grey.200",borderRadius:1}})})})},t)):le.length>0?le.map(n=>e.jsxs(b,{hover:!0,children:[e.jsxs(w,{children:["#",n.id]}),e.jsxs(w,{children:[e.jsxs(t,{variant:"body2",fontWeight:500,children:["#",n.original_sale_id]}),n.original_amount&&e.jsxs(t,{variant:"caption",color:"text.secondary",children:["Gốc: ",D(n.original_amount)]})]}),e.jsx(w,{children:e.jsxs(s,{children:[e.jsx(t,{variant:"body2",fontWeight:500,children:n.customer_name||"Khách vãng lai"}),n.customer_phone&&e.jsx(t,{variant:"caption",color:"text.secondary",children:n.customer_phone})]})}),e.jsx(w,{align:"right",children:e.jsx(t,{variant:"body2",fontWeight:600,color:"error.main",children:D(n.return_amount)})}),e.jsxs(w,{children:[e.jsx(t,{variant:"body2",children:n.return_reason}),n.notes&&e.jsx(t,{variant:"caption",color:"text.secondary",children:n.notes})]}),e.jsx(w,{children:me(n.return_status)}),e.jsxs(w,{children:[e.jsx(t,{variant:"body2",children:new Date(n.created_at).toLocaleDateString("vi-VN")}),e.jsx(t,{variant:"caption",color:"text.secondary",children:new Date(n.created_at).toLocaleTimeString("vi-VN")})]}),e.jsx(w,{align:"center",children:e.jsxs(s,{sx:{display:"flex",gap:.5},children:[e.jsx(j,{title:"Xem chi tiết",children:e.jsx(g,{size:"small",onClick:()=>{return e=n.id,void J(`/returns/${e}`);var e},children:e.jsx(R,{})})}),"completed"!==n.return_status&&e.jsx(j,{title:"Cập nhật trạng thái",children:e.jsx(g,{size:"small",onClick:()=>(e=>{ae({open:!0,returnItem:e,newStatus:e.return_status,notes:e.notes||""})})(n),children:e.jsx(O,{})})})]})})]},n.id)):e.jsx(b,{children:e.jsx(w,{colSpan:8,align:"center",children:e.jsx(m,{severity:"info",sx:{border:"none"},children:e.jsx(t,{children:"Không tìm thấy phiếu trả hàng nào."})})})})})]}),oe&&e.jsx(S,{component:"div",count:oe.total,page:je-1,onPageChange:(e,n)=>xe(n+1),rowsPerPage:ge,onRowsPerPageChange:e=>ue(parseInt(e.target.value)),rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:"Số dòng mỗi trang:",labelDisplayedRows:({from:e,to:n,count:t})=>`${e}-${n} của ${-1!==t?t:`hơn ${n}`}`})]}),e.jsxs(k,{open:re.open,onClose:()=>ae({open:!1,returnItem:null,newStatus:"",notes:""}),maxWidth:"sm",fullWidth:!0,children:[e.jsx(I,{children:"Cập nhật trạng thái trả hàng"}),e.jsx(_,{children:re.returnItem&&e.jsxs(s,{sx:{mt:2},children:[e.jsxs(t,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Phiếu trả hàng:"})," #",re.returnItem.id]}),e.jsxs(t,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Đơn hàng gốc:"})," #",re.returnItem.original_sale_id]}),e.jsxs(t,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Số tiền trả:"})," ",D(re.returnItem.return_amount)]}),e.jsx(T,{sx:{my:2}}),e.jsxs(h,{fullWidth:!0,margin:"normal",children:[e.jsx(d,{children:"Trạng thái"}),e.jsxs(x,{value:re.newStatus,label:"Trạng thái",onChange:e=>ae(n=>({...n,newStatus:e.target.value})),children:[e.jsx(u,{value:"pending",children:"Chờ duyệt"}),e.jsx(u,{value:"approved",children:"Đã duyệt"}),e.jsx(u,{value:"rejected",children:"Từ chối"}),e.jsx(u,{value:"completed",children:"Hoàn thành"})]})]}),e.jsx(o,{fullWidth:!0,label:"Ghi chú",value:re.notes,onChange:e=>ae(n=>({...n,notes:e.target.value})),margin:"normal",multiline:!0,rows:3,placeholder:"Ghi chú về việc cập nhật trạng thái..."})]})}),e.jsxs(P,{children:[e.jsx(r,{onClick:()=>ae({open:!1,returnItem:null,newStatus:"",notes:""}),children:"Hủy"}),e.jsx(r,{variant:"contained",onClick:async()=>{if(re.returnItem)try{const e=await fetch(`/api/v1/returns/${re.returnItem.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({return_status:re.newStatus,notes:re.notes})});if(!e.ok){const n=await e.json();throw new Error(n.message||"Lỗi khi cập nhật trạng thái")}M("Cập nhật trạng thái thành công",{variant:"success"}),ae({open:!1,returnItem:null,newStatus:"",notes:""}),de()}catch(e){M(e instanceof Error?e.message:"Lỗi khi cập nhật trạng thái",{variant:"error"})}},disabled:!re.newStatus,children:"Cập nhật"})]})]})]})};export{J as default};
