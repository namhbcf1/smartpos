<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart POS Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; }
        .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .title { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h3 { color: #1f2937; margin-bottom: 1rem; }
        .stats { display: flex; justify-content: space-between; align-items: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #3b82f6; }
        .btn { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn:hover { background: #2563eb; }
        .menu { background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .menu-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .menu-item { padding: 1rem; border: 1px solid #e5e7eb; border-radius: 4px; text-decoration: none; color: #374151; transition: all 0.2s; }
        .menu-item:hover { background: #f9fafb; border-color: #3b82f6; }
        .loading { text-align: center; color: #6b7280; }
        .error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 1rem; border-radius: 4px; margin: 1rem 0; }
        .user-info { float: right; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <h1 class="title">Smart POS Dashboard</h1>
            <div class="user-info">
                <span id="userInfo">Đang tải...</span>
                <button onclick="logout()" class="btn" style="margin-left: 1rem; background: #dc2626;">Đăng xuất</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="content">
            <div class="loading">Đang tải dữ liệu...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://namhbcf-api.bangachieu2.workers.dev/api';
        let authToken = sessionStorage.getItem('auth_token');
        let currentUser = null;

        // Check authentication
        if (!authToken) {
            window.location.href = '/login.html';
        }

        // Get user info
        try {
            currentUser = JSON.parse(sessionStorage.getItem('user') || '{}');
            document.getElementById('userInfo').textContent = `Xin chào, ${currentUser.username || 'Admin'}`;
        } catch (e) {
            console.warn('Could not parse user info');
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('auth_token');
            sessionStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // API call helper
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        ...options.headers
                    }
                });

                if (response.status === 401) {
                    logout();
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const [statsRes, productsRes] = await Promise.all([
                    apiCall('/dashboard/stats'),
                    apiCall('/products?limit=5')
                ]);

                const stats = statsRes?.data || {};
                const products = productsRes?.data?.data || [];

                document.getElementById('content').innerHTML = `
                    <div class="grid">
                        <div class="card">
                            <h3>Tổng quan hôm nay</h3>
                            <div class="stats">
                                <div>
                                    <div>Doanh thu</div>
                                    <div class="stat-value">${(stats.todayRevenue || 0).toLocaleString('vi-VN')} ₫</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Khách hàng</h3>
                            <div class="stats">
                                <div>
                                    <div>Tổng số</div>
                                    <div class="stat-value">${stats.totalCustomers || 0}</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Sản phẩm</h3>
                            <div class="stats">
                                <div>
                                    <div>Tổng số</div>
                                    <div class="stat-value">${stats.totalProducts || 0}</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Đơn hàng chờ</h3>
                            <div class="stats">
                                <div>
                                    <div>Số lượng</div>
                                    <div class="stat-value">${stats.pendingOrders || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="menu">
                        <h3>Menu chính</h3>
                        <div class="menu-items">
                            <a href="/login.html" class="menu-item">
                                <strong>Bán hàng POS</strong><br>
                                Giao diện bán hàng nhanh
                            </a>
                            <a href="#" onclick="showProducts()" class="menu-item">
                                <strong>Quản lý sản phẩm</strong><br>
                                Thêm, sửa, xóa sản phẩm
                            </a>
                            <a href="#" onclick="showCustomers()" class="menu-item">
                                <strong>Khách hàng</strong><br>
                                Quản lý thông tin khách hàng
                            </a>
                            <a href="#" onclick="showReports()" class="menu-item">
                                <strong>Báo cáo</strong><br>
                                Thống kê doanh thu, bán hàng
                            </a>
                            <a href="#" onclick="showInventory()" class="menu-item">
                                <strong>Kho hàng</strong><br>
                                Quản lý tồn kho, nhập xuất
                            </a>
                            <a href="#" onclick="showSettings()" class="menu-item">
                                <strong>Cài đặt</strong><br>
                                Cấu hình hệ thống
                            </a>
                        </div>
                    </div>

                    ${products.length > 0 ? `
                    <div class="card" style="margin-top: 1.5rem;">
                        <h3>Sản phẩm gần đây</h3>
                        <div style="margin-top: 1rem;">
                            ${products.map(p => `
                                <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">
                                    <strong>${p.name}</strong> - ${(p.price || 0).toLocaleString('vi-VN')} ₫
                                    <small style="color: #6b7280; margin-left: 1rem;">SKU: ${p.sku}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;

            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        Có lỗi xảy ra khi tải dữ liệu: ${error.message}
                        <br><button onclick="loadDashboard()" class="btn" style="margin-top: 1rem;">Thử lại</button>
                    </div>
                `;
            }
        }

        // Navigation functions
        function showProducts() {
            alert('Chức năng quản lý sản phẩm đang được phát triển. Vui lòng sử dụng API endpoints.');
        }

        function showCustomers() {
            alert('Chức năng quản lý khách hàng đang được phát triển. Vui lòng sử dụng API endpoints.');
        }

        function showReports() {
            alert('Chức năng báo cáo đang được phát triển. Vui lòng sử dụng API endpoints.');
        }

        function showInventory() {
            alert('Chức năng quản lý kho đang được phát triển. Vui lòng sử dụng API endpoints.');
        }

        function showSettings() {
            alert('Chức năng cài đặt đang được phát triển. Vui lòng sử dụng API endpoints.');
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>