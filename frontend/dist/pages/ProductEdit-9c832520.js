import{j as e,W as c,ad as ae,af as N,ae as w,aB as se,aw as ie,T as l,t as j,Y as z,Z as F,aj as a,E as d,ak as R,al as q,am as M,ab as S,V as ne,C as T,aC as $,aD as U,D as le,ay as oe,o as ce,ap as ue,P as de,aq as he,ar as xe,as as K,at as h,au as me,v as pe}from"../chunks/mui-core-cd9e8750.js";import{j as ge,u as je,r as x}from"../chunks/react-vendor-9ee90314.js";import{u as be,b as fe}from"../chunks/useApiData-60d9f817.js";import{r as m,a as ye}from"../assets/index-fad1ea34.js";import{$ as ke,t as ve,w as Se,a as G,Y as _e,a0 as Ce,E as we,W as Te,l as Ie}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/utils-vendor-8faa4a85.js";import"../chunks/query-vendor-0e167262.js";import"../chunks/ui-vendor-11834b8a.js";const Ne=()=>{const{id:u}=ge(),_=je(),[H,I]=x.useState(!0),[P,b]=x.useState(null),[V,Y]=x.useState(null),[f,X]=x.useState([]),[p,Z]=x.useState(null),[J,D]=x.useState(!1),[O,k]=x.useState(!1),[g,L]=x.useState("manual"),[s,y]=x.useState({name:"",description:"",sku:"",barcode:"",categoryId:"",price:"",costPrice:"",taxRate:"",discountEligible:!0,stockQuantity:"",calculatedStock:0,stockAlertThreshold:"",minStockLevel:"",maxStockLevel:"",reorderPoint:"",reorderQuantity:"",brand:"",model:"",unit:"piece",weight:"",dimensions:"",color:"",size:"",supplierId:"",supplierSku:"",supplierPrice:"",warrantyPeriodMonths:"12",warrantyType:"manufacturer",warrantyTerms:"",imageUrl:"",videoUrl:"",metaTitle:"",metaDescription:"",tags:[],isActive:!0,isFeatured:!1,isDigital:!1,requiresShipping:!0,trackQuantity:!0}),{data:ee=[]}=be("/categories",{limit:100,is_active:!0}),{update:te,loading:A,error:W}=fe(),v=async()=>{if(u)try{D(!0),console.log("🔍 Fetching serial numbers for product:",u);const t=await ye.get(`/serial-numbers?product_id=${u}&limit=1000`);if(t.success&&t.data){X(t.data);const i={total_serials:t.data.length,in_stock:t.data.filter(n=>n.status==="in_stock").length,sold:t.data.filter(n=>n.status==="sold").length,warranty_claim:t.data.filter(n=>n.status==="warranty_claim").length,defective:t.data.filter(n=>n.status==="defective").length,returned:t.data.filter(n=>n.status==="returned").length,disposed:t.data.filter(n=>n.status==="disposed").length};Z(i),y(n=>({...n,calculatedStock:i.in_stock})),console.log("📊 Serial numbers loaded:",i)}}catch(t){console.error("❌ Error fetching serial numbers:",t)}finally{D(!1)}};x.useEffect(()=>{(async()=>{if(u)try{I(!0),b(null),console.log("🔍 Fetching product with ID:",u);const i=await fetch(`https://smartpos-api.bangachieu2.workers.dev/test-product/${u}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json",Accept:"application/json"}});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const n=await i.json();console.log("📦 API Response:",n);let r=null;n.success&&n.data||n.data?r=n.data:r=n,console.log("📋 Product Data:",r),r&&r.id?(Y(r),y({name:r.name||"",description:r.description||"",sku:r.sku||"",barcode:r.barcode||"",categoryId:r.categoryId?.toString()||"",price:r.price?.toString()||"",costPrice:r.costPrice?.toString()||"",taxRate:r.taxRate?.toString()||"",discountEligible:r.discountEligible??!0,stockQuantity:r.stockQuantity?.toString()||"",calculatedStock:0,stockAlertThreshold:r.stockAlertThreshold?.toString()||"",minStockLevel:r.minStockLevel?.toString()||"",maxStockLevel:r.maxStockLevel?.toString()||"",reorderPoint:r.reorderPoint?.toString()||"",reorderQuantity:r.reorderQuantity?.toString()||"",brand:r.brand||"",model:r.model||"",unit:r.unit||"piece",weight:r.weight?.toString()||"",dimensions:r.dimensions||"",color:r.color||"",size:r.size||"",supplierId:r.supplierId?.toString()||"",supplierSku:r.supplierSku||"",supplierPrice:r.supplierPrice?.toString()||"",warrantyPeriodMonths:r.warrantyPeriodMonths?.toString()||"12",warrantyType:r.warrantyType||"manufacturer",warrantyTerms:r.warrantyTerms||"",imageUrl:r.imageUrl||"",videoUrl:r.videoUrl||"",metaTitle:r.metaTitle||"",metaDescription:r.metaDescription||"",tags:r.tags||[],isActive:r.isActive??!0,isFeatured:r.isFeatured??!1,isDigital:r.isDigital??!1,requiresShipping:r.requiresShipping??!0,trackQuantity:r.trackQuantity??!0}),L(r.trackQuantity?"auto":"manual"),console.log("✅ Product data loaded successfully"),await v()):(b("Không thể tải thông tin sản phẩm - dữ liệu không hợp lệ"),console.error("❌ Invalid product data:",r))}catch(i){console.error("❌ Error fetching product:",i),i.response?.status===404?b("Không tìm thấy sản phẩm"):i.response?.status===401?b("Không có quyền truy cập"):i.response?.status===500?b("Lỗi máy chủ - vui lòng thử lại sau"):b("Lỗi khi tải dữ liệu sản phẩm")}finally{I(!1)}})()},[u]),x.useEffect(()=>{if(!u)return;m.connect(),m.subscribeToProduct(parseInt(u));const t=i=>{i.data.product_id===parseInt(u)&&(console.log("📡 Received real-time product update:",i),i.type==="stock_updated"&&(y(n=>({...n,stockQuantity:i.data.current_stock.toString()})),console.log(`📦 Stock updated: ${i.data.product_name} - ${i.data.current_stock} units`)),i.type==="serial_number_updated"&&v(),i.type==="product_updated"&&fetchProduct())};return m.subscribe("stock_updated",t),m.subscribe("product_updated",t),m.subscribe("serial_number_updated",t),m.subscribe("stock_low",t),()=>{m.unsubscribe("stock_updated",t),m.unsubscribe("product_updated",t),m.unsubscribe("serial_number_updated",t),m.unsubscribe("stock_low",t),m.unsubscribeFromProduct(parseInt(u))}},[u]);const o=(t,i)=>{y(n=>({...n,[t]:i}))},C=t=>{L(t),t==="auto"&&p&&y(i=>({...i,stockQuantity:p.in_stock.toString(),trackQuantity:!0}))},re=async t=>{if(t.preventDefault(),!!u)try{const i={name:s.name,description:s.description,sku:s.sku,barcode:s.barcode||null,category_id:parseInt(s.categoryId),price:parseFloat(s.price),cost_price:parseFloat(s.costPrice),tax_rate:parseFloat(s.taxRate),stock_quantity:g==="auto"?s.calculatedStock:parseInt(s.stockQuantity),stock_alert_threshold:parseInt(s.stockAlertThreshold),track_quantity:g==="auto",is_active:s.isActive,warranty_period_months:parseInt(s.warrantyPeriodMonths),warranty_type:s.warrantyType};await te(`/products/${u}`,i)&&(await v(),_("/products"))}catch(i){console.error("Error updating product:",i)}},B=()=>{_("/products")},Q=t=>{switch(t){case"in_stock":return"success";case"sold":return"primary";case"warranty_claim":return"warning";case"defective":return"error";case"returned":return"info";case"disposed":return"default";default:return"default"}},E=t=>{switch(t){case"in_stock":return e.jsx(G,{fontSize:"small"});case"sold":return e.jsx(Ie,{fontSize:"small"});case"warranty_claim":return e.jsx(Te,{fontSize:"small"});case"defective":return e.jsx(we,{fontSize:"small"});default:return null}};return H?e.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(ae,{})}):P?e.jsx(N,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsx(w,{severity:"error",children:P})}):e.jsxs(N,{maxWidth:"lg",sx:{mt:4,mb:4},children:[e.jsxs(se,{sx:{mb:3},children:[e.jsx(ie,{color:"inherit",href:"/products",onClick:t=>{t.preventDefault(),_("/products")},children:"Sản phẩm"}),e.jsx(l,{color:"text.primary",children:"Chỉnh sửa sản phẩm"})]}),e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(l,{variant:"h4",component:"h1",children:"Chỉnh sửa sản phẩm"}),e.jsx(j,{variant:"outlined",startIcon:e.jsx(ke,{}),onClick:B,children:"Quay lại"})]}),p&&e.jsx(z,{sx:{mb:3},children:e.jsxs(F,{children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(l,{variant:"h6",children:"📊 Tổng quan Serial Numbers"}),e.jsxs(c,{sx:{display:"flex",gap:1},children:[e.jsx(j,{size:"small",startIcon:e.jsx(ve,{}),onClick:v,disabled:J,children:"Làm mới"}),e.jsx(j,{size:"small",startIcon:e.jsx(Se,{}),onClick:()=>k(!0),children:"Xem chi tiết"})]})]}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:6,md:2,children:e.jsxs(c,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",color:"primary",children:p.total_serials}),e.jsx(l,{variant:"caption",children:"Tổng SN"})]})}),e.jsx(a,{item:!0,xs:6,md:2,children:e.jsxs(c,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",color:"success.main",children:p.in_stock}),e.jsx(l,{variant:"caption",children:"Trong kho"})]})}),e.jsx(a,{item:!0,xs:6,md:2,children:e.jsxs(c,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",color:"info.main",children:p.sold}),e.jsx(l,{variant:"caption",children:"Đã bán"})]})}),e.jsx(a,{item:!0,xs:6,md:2,children:e.jsxs(c,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",color:"warning.main",children:p.warranty_claim}),e.jsx(l,{variant:"caption",children:"Bảo hành"})]})}),e.jsx(a,{item:!0,xs:6,md:2,children:e.jsxs(c,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",color:"error.main",children:p.defective}),e.jsx(l,{variant:"caption",children:"Lỗi"})]})}),e.jsx(a,{item:!0,xs:6,md:2,children:e.jsxs(c,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h4",color:"text.secondary",children:p.returned}),e.jsx(l,{variant:"caption",children:"Trả lại"})]})})]}),e.jsxs(c,{sx:{mt:2,p:2,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider"},children:[e.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Chế độ tính toán tồn kho:"}),e.jsxs(c,{sx:{display:"flex",gap:2},children:[e.jsxs(j,{variant:g==="manual"?"contained":"outlined",size:"small",onClick:()=>C("manual"),children:["Thủ công (",s.stockQuantity||0,")"]}),e.jsxs(j,{variant:g==="auto"?"contained":"outlined",size:"small",onClick:()=>C("auto"),color:"success",children:["Tự động (",p.in_stock,")"]})]}),g==="auto"&&e.jsx(w,{severity:"info",sx:{mt:1},children:'Số lượng tồn kho sẽ được tính tự động từ Serial Numbers có trạng thái "Trong kho"'})]})]})}),e.jsx(z,{children:e.jsx(F,{children:e.jsx("form",{onSubmit:re,children:e.jsxs(a,{container:!0,spacing:3,children:[e.jsx(a,{item:!0,xs:12,children:e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Thông tin cơ bản"})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:"Tên sản phẩm",value:s.name,onChange:t=>o("name",t.target.value),required:!0})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:"SKU",value:s.sku,onChange:t=>o("sku",t.target.value),required:!0})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(d,{fullWidth:!0,label:"Mô tả",value:s.description,onChange:t=>o("description",t.target.value),multiline:!0,rows:3})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:"Barcode",value:s.barcode,onChange:t=>o("barcode",t.target.value)})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsxs(R,{fullWidth:!0,children:[e.jsx(q,{children:"Danh mục"}),e.jsx(M,{value:s.categoryId,onChange:t=>o("categoryId",t.target.value),label:"Danh mục",required:!0,children:ee.map(t=>e.jsx(S,{value:t.id.toString(),children:t.name},t.id))})]})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Giá cả"})}),e.jsx(a,{item:!0,xs:12,md:4,children:e.jsx(d,{fullWidth:!0,label:"Giá bán",type:"number",value:s.price,onChange:t=>o("price",t.target.value),required:!0})}),e.jsx(a,{item:!0,xs:12,md:4,children:e.jsx(d,{fullWidth:!0,label:"Giá vốn",type:"number",value:s.costPrice,onChange:t=>o("costPrice",t.target.value),required:!0})}),e.jsx(a,{item:!0,xs:12,md:4,children:e.jsx(d,{fullWidth:!0,label:"Thuế (%)",type:"number",value:s.taxRate,onChange:t=>o("taxRate",t.target.value)})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Tồn kho & Serial Numbers"})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:g==="auto"?"Số lượng tồn kho (Tự động)":"Số lượng tồn kho",type:"number",value:g==="auto"?s.calculatedStock:s.stockQuantity,onChange:t=>o("stockQuantity",t.target.value),disabled:g==="auto",InputProps:{endAdornment:g==="auto"&&e.jsx(ne,{title:"Được tính tự động từ Serial Numbers",children:e.jsx(G,{color:"success"})})}})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:"Ngưỡng cảnh báo tồn kho",type:"number",value:s.stockAlertThreshold,onChange:t=>o("stockAlertThreshold",t.target.value)})}),f.length>0&&e.jsx(a,{item:!0,xs:12,children:e.jsxs(c,{sx:{p:2,bgcolor:"background.paper",borderRadius:1,border:1,borderColor:"divider"},children:[e.jsxs(l,{variant:"subtitle2",gutterBottom:!0,children:["Serial Numbers (",f.length," total):"]}),e.jsxs(c,{sx:{display:"flex",flexWrap:"wrap",gap:1,maxHeight:200,overflow:"auto"},children:[f.slice(0,20).map(t=>e.jsx(T,{label:t.serial_number,color:Q(t.status),size:"small",icon:E(t.status),variant:t.status==="in_stock"?"filled":"outlined"},t.serial_number)),f.length>20&&e.jsx(T,{label:`+${f.length-20} more`,variant:"outlined",size:"small",onClick:()=>k(!0)})]})]})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:"Tồn kho tối thiểu",type:"number",value:s.minStockLevel,onChange:t=>o("minStockLevel",t.target.value)})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(d,{fullWidth:!0,label:"Tồn kho tối đa",type:"number",value:s.maxStockLevel,onChange:t=>o("maxStockLevel",t.target.value)})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Bảo hành"})}),e.jsx(a,{item:!0,xs:12,md:4,children:e.jsx(d,{fullWidth:!0,label:"Thời gian bảo hành (tháng)",type:"number",value:s.warrantyPeriodMonths,onChange:t=>o("warrantyPeriodMonths",t.target.value)})}),e.jsx(a,{item:!0,xs:12,md:4,children:e.jsxs(R,{fullWidth:!0,children:[e.jsx(q,{children:"Loại bảo hành"}),e.jsxs(M,{value:s.warrantyType,onChange:t=>o("warrantyType",t.target.value),label:"Loại bảo hành",children:[e.jsx(S,{value:"manufacturer",children:"Bảo hành nhà sản xuất"}),e.jsx(S,{value:"store",children:"Bảo hành cửa hàng"}),e.jsx(S,{value:"extended",children:"Bảo hành mở rộng"})]})]})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"Trạng thái & Cài đặt"})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx($,{control:e.jsx(U,{checked:s.isActive,onChange:t=>o("isActive",t.target.checked)}),label:"Kích hoạt sản phẩm"})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx($,{control:e.jsx(U,{checked:g==="auto",onChange:t=>C(t.target.checked?"auto":"manual")}),label:"Theo dõi số lượng bằng Serial Numbers"})}),W&&e.jsx(a,{item:!0,xs:12,children:e.jsx(w,{severity:"error",children:W})}),e.jsx(a,{item:!0,xs:12,children:e.jsxs(c,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:3},children:[e.jsx(j,{variant:"outlined",onClick:B,startIcon:e.jsx(_e,{}),children:"Hủy"}),e.jsx(j,{type:"submit",variant:"contained",startIcon:e.jsx(Ce,{}),disabled:A,children:A?"Đang lưu...":"Lưu thay đổi"})]})})]})})})}),e.jsxs(le,{open:O,onClose:()=>k(!1),maxWidth:"lg",fullWidth:!0,children:[e.jsxs(oe,{children:["Chi tiết Serial Numbers - ",V?.name]}),e.jsx(ce,{children:e.jsx(ue,{component:de,children:e.jsxs(he,{size:"small",children:[e.jsx(xe,{children:e.jsxs(K,{children:[e.jsx(h,{children:"Serial Number"}),e.jsx(h,{children:"Trạng thái"}),e.jsx(h,{children:"Khách hàng"}),e.jsx(h,{children:"Ngày bán"}),e.jsx(h,{children:"Bảo hành đến"}),e.jsx(h,{children:"Nhà cung cấp"})]})}),e.jsx(me,{children:f.map(t=>e.jsxs(K,{children:[e.jsx(h,{children:e.jsx(l,{variant:"body2",fontFamily:"monospace",children:t.serial_number})}),e.jsx(h,{children:e.jsx(T,{label:t.status,color:Q(t.status),size:"small",icon:E(t.status)})}),e.jsx(h,{children:t.customer_name||"-"}),e.jsx(h,{children:t.sold_date?new Date(t.sold_date).toLocaleDateString("vi-VN"):"-"}),e.jsx(h,{children:t.warranty_end_date?new Date(t.warranty_end_date).toLocaleDateString("vi-VN"):"-"}),e.jsx(h,{children:t.supplier_name||"-"})]},t.serial_number))})]})})}),e.jsx(pe,{children:e.jsx(j,{onClick:()=>k(!1),children:"Đóng"})})]})]})};export{Ne as default};
