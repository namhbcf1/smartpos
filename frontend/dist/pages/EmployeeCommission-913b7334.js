import{j as e,D as me,ay as je,W as a,T as t,I as E,o as ge,ad as re,aK as ts,aL as ye,ae as ne,E as C,aP as as,aQ as is,C as R,aR as ls,aj as l,Y as W,Z as $,aC as os,aD as cs,ak as de,al as ue,am as xe,ab as I,t as p,a3 as hs,v as pe,aO as _e,V as Z,e as ds,p as us,av as Pe,$ as Te,P as ee,A as se,an as xs,ap as ms,aq as js,ar as gs,as as be,at as _,au as ps,a8 as fs,aS as vs}from"../chunks/mui-core-cd9e8750.js";import{r as c}from"../chunks/react-vendor-9ee90314.js";import{a as we}from"../chunks/ui-vendor-11834b8a.js";import{u as ys}from"../chunks/useApiData-60d9f817.js";import{a as w,b as bs}from"../assets/index-fad1ea34.js";import{a as Ie}from"../chunks/utils-vendor-8faa4a85.js";import{n as Y,av as $e,al as Cs,ab as ws,d as ks,a0 as De,T as Me,Z as Be,_ as qe,aX as Fe,B as _s,aY as Ve,x as He,j as Ps,aW as Qe,P as Se,t as Le,aZ as he,a_ as Ne,y as ze,e as Ts,V as Ae,w as Ee}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/query-vendor-0e167262.js";function Ce(g){const{children:h,value:x,index:b,...m}=g;return e.jsx("div",{role:"tabpanel",hidden:x!==b,id:`permission-tabpanel-${b}`,"aria-labelledby":`permission-tab-${b}`,...m,children:x===b&&e.jsx(a,{sx:{p:3},children:h})})}const Is=({open:g,onClose:h,employee:x,onPermissionsUpdated:b})=>{const[m,H]=c.useState(0),[q,X]=c.useState(!1),[D,S]=c.useState(!1),[M,y]=c.useState(null),[j,L]=c.useState([]),[z,F]=c.useState([]),[Q,G]=c.useState([]),[V,N]=c.useState(""),[O,r]=c.useState(""),[d,P]=c.useState(new Map),{enqueueSnackbar:i}=we();c.useEffect(()=>{g&&x&&B()},[g,x]);const B=async()=>{if(x){X(!0);try{const[n,u,A,k]=await Promise.all([w.get(`/permissions/employees/${x.id}/matrix`),w.get("/permissions/roles/templates"),w.get(`/permissions/employees/${x.id}/roles`),w.get(`/permissions/employees/${x.id}/audit?limit=20`)]);y(n.data),L(u.data),F(A.data),G(k.data)}catch(n){console.error("Error loading permission data:",n),i("Lỗi khi tải dữ liệu quyền hạn",{variant:"error"})}finally{X(!1)}}},te=(n,u)=>{const A=new Map(d);if(A.set(n,u),P(A),M){const k={...M};k.resources=k.resources.map(ie=>({...ie,actions:ie.actions.map(le=>le.permission_key===n?{...le,has_permission:u,permission_source:"individual"}:le)})),y(k)}},ae=async()=>{if(!(!x||d.size===0)){S(!0);try{const n=Array.from(d.entries()).map(([u,A])=>({permission_key:u,granted:A}));await w.put(`/permissions/employees/${x.id}/bulk`,{permissions:n,reason:O.trim()||void 0}),i("Cập nhật quyền hạn thành công",{variant:"success"}),P(new Map),r(""),b(),await B()}catch(n){console.error("Error saving permissions:",n),i("Lỗi khi lưu quyền hạn",{variant:"error"})}finally{S(!1)}}},U=async()=>{if(!(!x||!V)){S(!0);try{await w.post(`/permissions/employees/${x.id}/roles`,{role_id:V}),i("Gán vai trò thành công",{variant:"success"}),N(""),b(),await B()}catch(n){console.error("Error assigning role:",n),i("Lỗi khi gán vai trò",{variant:"error"})}finally{S(!1)}}},K=async n=>{if(x){S(!0);try{await w.delete(`/permissions/employees/${x.id}/roles/${n}`),i("Xóa vai trò thành công",{variant:"success"}),b(),await B()}catch(u){console.error("Error removing role:",u),i("Lỗi khi xóa vai trò",{variant:"error"})}finally{S(!1)}}},fe=n=>{switch(n){case"menu":return"📋";case"database":return"🗄️";case"feature":return"⚙️";default:return"📄"}},f=n=>{switch(n){case"menu":return"primary";case"database":return"secondary";case"feature":return"warning";default:return"default"}};return x?e.jsxs(me,{open:g,onClose:h,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh"}},children:[e.jsx(je,{children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(Y,{color:"primary"}),e.jsxs(a,{children:[e.jsxs(t,{variant:"h6",children:["Quản lý quyền hạn - ",x.full_name]}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:[x.email," • ",x.role]})]})]}),e.jsx(E,{onClick:h,children:e.jsx($e,{})})]})}),e.jsx(ge,{dividers:!0,children:q?e.jsx(a,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:400,children:e.jsx(re,{})}):e.jsxs(e.Fragment,{children:[e.jsxs(ts,{value:m,onChange:(n,u)=>H(u),children:[e.jsx(ye,{icon:e.jsx(Y,{}),label:"Ma trận quyền hạn"}),e.jsx(ye,{icon:e.jsx(Cs,{}),label:"Vai trò"}),e.jsx(ye,{icon:e.jsx(ws,{}),label:"Lịch sử thay đổi"})]}),e.jsxs(Ce,{value:m,index:0,children:[d.size>0&&e.jsxs(ne,{severity:"info",sx:{mb:2},children:["Bạn có ",d.size,' thay đổi chưa lưu. Nhấn "Lưu thay đổi" để áp dụng.']}),e.jsx(C,{fullWidth:!0,multiline:!0,rows:2,label:"Lý do thay đổi (tùy chọn)",value:O,onChange:n=>r(n.target.value),sx:{mb:2},placeholder:"Nhập lý do thay đổi quyền hạn..."}),M?.resources.map(n=>e.jsxs(as,{sx:{mb:1},children:[e.jsx(is,{expandIcon:e.jsx(ks,{}),children:e.jsxs(a,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(t,{variant:"h6",children:[fe(n.resource_type)," ",n.display_name]}),e.jsx(R,{label:n.resource_type,size:"small",color:f(n.resource_type)}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:["(",n.actions.filter(u=>u.has_permission).length,"/",n.actions.length," quyền)"]})]})}),e.jsx(ls,{children:e.jsx(l,{container:!0,spacing:2,children:n.actions.map(u=>e.jsx(l,{item:!0,xs:12,sm:6,md:4,children:e.jsx(W,{variant:"outlined",sx:{height:"100%"},children:e.jsx($,{sx:{p:2},children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{children:[e.jsx(t,{variant:"subtitle2",children:u.display_name}),e.jsx(t,{variant:"caption",color:"text.secondary",children:u.permission_key}),u.permission_source&&e.jsx(R,{label:u.permission_source==="role"?"Từ vai trò":"Cá nhân",size:"small",color:u.permission_source==="role"?"default":"primary",sx:{mt:.5,fontSize:"0.7rem"}})]}),e.jsx(os,{control:e.jsx(cs,{checked:u.has_permission,onChange:A=>te(u.permission_key,A.target.checked),color:"primary"}),label:""})]})})})},u.permission_key))})})]},n.id))]}),e.jsxs(Ce,{value:m,index:1,children:[e.jsxs(a,{mb:3,children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Gán vai trò mẫu"}),e.jsxs(a,{display:"flex",gap:2,alignItems:"center",children:[e.jsxs(de,{sx:{minWidth:300},children:[e.jsx(ue,{children:"Chọn vai trò mẫu"}),e.jsx(xe,{value:V,onChange:n=>N(n.target.value),label:"Chọn vai trò mẫu",children:j.map(n=>e.jsxs(I,{value:n.id,children:[n.display_name," (",n.permission_count," quyền)"]},n.id))})]}),e.jsx(p,{variant:"contained",onClick:U,disabled:!V||D,children:"Gán vai trò"})]})]}),e.jsx(hs,{sx:{my:2}}),e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Vai trò hiện tại"}),z.length===0?e.jsx(ne,{severity:"info",children:"Nhân viên chưa được gán vai trò nào."}):e.jsx(l,{container:!0,spacing:2,children:z.map(n=>e.jsx(l,{item:!0,xs:12,sm:6,md:4,children:e.jsx(W,{children:e.jsx($,{children:e.jsxs(a,{display:"flex",justifyContent:"between",alignItems:"start",children:[e.jsxs(a,{flex:1,children:[e.jsx(t,{variant:"h6",children:n.display_name}),e.jsx(t,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:n.description}),e.jsx(R,{label:`${n.permission_count} quyền`,size:"small",color:"primary"}),n.is_system&&e.jsx(R,{label:"Hệ thống",size:"small",color:"secondary",sx:{ml:1}})]}),e.jsx(p,{size:"small",color:"error",onClick:()=>K(n.id),disabled:D,children:"Xóa"})]})})})},n.id))})]}),e.jsxs(Ce,{value:m,index:2,children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Lịch sử thay đổi quyền hạn"}),Q.length===0?e.jsx(ne,{severity:"info",children:"Chưa có lịch sử thay đổi quyền hạn."}):e.jsx(a,{children:Q.map((n,u)=>e.jsx(W,{sx:{mb:1},children:e.jsx($,{sx:{p:2},children:e.jsxs(a,{display:"flex",justifyContent:"between",alignItems:"start",children:[e.jsxs(a,{children:[e.jsx(t,{variant:"subtitle2",children:n.permission_key}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:[n.action," bởi ",n.changed_by_name]}),n.reason&&e.jsxs(t,{variant:"caption",color:"text.secondary",children:["Lý do: ",n.reason]})]}),e.jsx(t,{variant:"caption",color:"text.secondary",children:new Date(n.created_at).toLocaleString("vi-VN")})]})})},u))})]})]})}),e.jsxs(pe,{children:[e.jsx(p,{onClick:h,disabled:D,children:"Đóng"}),m===0&&d.size>0&&e.jsxs(p,{variant:"contained",startIcon:D?e.jsx(re,{size:20}):e.jsx(De,{}),onClick:ae,disabled:D,children:["Lưu thay đổi (",d.size,")"]})]})]}):null},Ss=({open:g,onClose:h,onRoleTemplateCreated:x})=>{const[b,m]=c.useState(!1),[H,q]=c.useState([]),[X,D]=c.useState(null),[S,M]=c.useState(!1),[y,j]=c.useState({name:"",display_name:"",description:"",is_template:!0}),{enqueueSnackbar:L}=we();c.useEffect(()=>{g&&z()},[g]);const z=async()=>{m(!0);try{const r=await w.get("/permissions/roles/templates");q(r.data)}catch(r){console.error("Error loading role templates:",r),L("Lỗi khi tải danh sách vai trò",{variant:"error"})}finally{m(!1)}},F=r=>r.includes("admin")?e.jsx(Fe,{}):r.includes("manager")?e.jsx(_s,{}):r.includes("cashier")?e.jsx(Ve,{}):r.includes("sales")?e.jsx(He,{}):r.includes("inventory")?e.jsx(Ps,{}):r.includes("affiliate")?e.jsx(Qe,{}):e.jsx(Y,{}),Q=r=>r.includes("admin")?"error":r.includes("manager")?"warning":r.includes("cashier")?"primary":r.includes("sales")?"success":r.includes("inventory")?"info":r.includes("affiliate")?"secondary":"default",G=async()=>{try{if(m(!0),!y.name||!y.display_name){L("Vui lòng nhập tên và tên hiển thị",{variant:"error"});return}(await w.post("/permissions/roles/templates",y)).success&&(L("Tạo vai trò mẫu thành công",{variant:"success"}),M(!1),j({name:"",display_name:"",description:"",is_template:!0}),await z(),x?.())}catch(r){console.error("Error creating role template:",r),L("Lỗi khi tạo vai trò mẫu",{variant:"error"})}finally{m(!1)}},V=async r=>{if(confirm("Bạn có chắc muốn xóa vai trò mẫu này?"))try{m(!0),(await w.delete(`/permissions/roles/templates/${r}`)).success&&(L("Xóa vai trò mẫu thành công",{variant:"success"}),await z(),x?.())}catch(d){console.error("Error deleting role template:",d),L("Lỗi khi xóa vai trò mẫu",{variant:"error"})}finally{m(!1)}},N=H.filter(r=>r.is_system),O=H.filter(r=>!r.is_system);return e.jsxs(me,{open:g,onClose:h,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"80vh"}},children:[e.jsx(je,{children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(Y,{color:"primary"}),e.jsx(t,{variant:"h6",children:"Quản lý vai trò mẫu"})]}),e.jsxs(a,{children:[e.jsx(p,{variant:"contained",startIcon:e.jsx(Me,{}),onClick:()=>M(!0),sx:{mr:1},children:"Tạo vai trò mới"}),e.jsx(E,{onClick:h,children:e.jsx($e,{})})]})]})}),e.jsx(ge,{dividers:!0,children:b?e.jsx(a,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:400,children:e.jsx(re,{})}):e.jsxs(e.Fragment,{children:[S&&e.jsxs(W,{sx:{mb:3,border:"2px dashed",borderColor:"primary.main"},children:[e.jsxs($,{children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Tạo vai trò mẫu mới"}),e.jsxs(l,{container:!0,spacing:2,children:[e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Tên vai trò (tiếng Anh)",value:y.name,onChange:r=>j({...y,name:r.target.value}),placeholder:"e.g., custom_manager"})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Tên hiển thị",value:y.display_name,onChange:r=>j({...y,display_name:r.target.value}),placeholder:"e.g., Quản lý tùy chỉnh"})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(C,{fullWidth:!0,multiline:!0,rows:2,label:"Mô tả",value:y.description,onChange:r=>j({...y,description:r.target.value}),placeholder:"Mô tả vai trò và quyền hạn..."})})]})]}),e.jsxs(_e,{children:[e.jsx(p,{variant:"contained",startIcon:e.jsx(De,{}),onClick:G,disabled:b,children:"Tạo vai trò"}),e.jsx(p,{onClick:()=>M(!1),children:"Hủy"})]})]}),e.jsx(t,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"🏛️ Vai trò hệ thống"}),e.jsx(ne,{severity:"info",sx:{mb:2},children:"Các vai trò hệ thống được định nghĩa sẵn và không thể chỉnh sửa hoặc xóa."}),e.jsx(l,{container:!0,spacing:2,children:N.map(r=>e.jsx(l,{item:!0,xs:12,sm:6,md:4,children:e.jsx(W,{sx:{height:"100%"},children:e.jsxs($,{children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:2,mb:2,children:[F(r.name),e.jsx(t,{variant:"h6",children:r.display_name})]}),e.jsx(t,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:r.description}),e.jsxs(a,{display:"flex",gap:1,mt:2,children:[e.jsx(R,{label:`${r.permission_count} quyền`,size:"small",color:Q(r.name)}),e.jsx(R,{label:"Hệ thống",size:"small",color:"default"})]})]})})},r.id))}),e.jsx(t,{variant:"h6",gutterBottom:!0,sx:{mt:4},children:"🎨 Vai trò tùy chỉnh"}),O.length===0?e.jsx(ne,{severity:"info",children:'Chưa có vai trò tùy chỉnh nào. Nhấn "Tạo vai trò mới" để tạo vai trò tùy chỉnh.'}):e.jsx(l,{container:!0,spacing:2,children:O.map(r=>e.jsx(l,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(W,{sx:{height:"100%"},children:[e.jsxs($,{children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:2,mb:2,children:[F(r.name),e.jsx(t,{variant:"h6",children:r.display_name})]}),e.jsx(t,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:r.description}),e.jsxs(a,{display:"flex",gap:1,mt:2,children:[e.jsx(R,{label:`${r.permission_count} quyền`,size:"small",color:Q(r.name)}),e.jsx(R,{label:"Tùy chỉnh",size:"small",color:"primary"})]})]}),e.jsxs(_e,{children:[e.jsx(Z,{title:"Chỉnh sửa vai trò",children:e.jsx(E,{size:"small",onClick:()=>D(r),color:"primary",children:e.jsx(Be,{})})}),e.jsx(Z,{title:"Xóa vai trò",children:e.jsx(E,{size:"small",onClick:()=>V(r.id),color:"error",children:e.jsx(qe,{})})})]})]})},r.id))})]})}),e.jsx(pe,{children:e.jsx(p,{onClick:h,children:"Đóng"})})]})},Re=g=>{switch(g){case"admin":return"Quản trị viên";case"cashier":return"Thu ngân";case"sales_agent":return"Nhân viên kinh doanh";case"affiliate":return"Cộng tác viên";default:return g}},We=g=>{switch(g){case"admin":return"error";case"cashier":return"primary";case"sales_agent":return"info";case"affiliate":return"success";default:return"default"}},Ls=g=>{switch(g){case"admin":return e.jsx(Fe,{});case"cashier":return e.jsx(Ve,{});case"sales_agent":return e.jsx(He,{});case"affiliate":return e.jsx(Qe,{});default:return e.jsx(Ne,{})}},qs=()=>{const g=ds();us(g.breakpoints.down("md"));const{enqueueSnackbar:h}=we(),[x,b]=c.useState(""),[m,H]=c.useState(""),[q,X]=c.useState("active"),[D,S]=c.useState(!1),[M,y]=c.useState(!1),[j,L]=c.useState(null),[z,F]=c.useState(null),[Q,G]=c.useState(!1),[V,N]=c.useState(null),[O,r]=c.useState(!1),[d,P]=c.useState({full_name:"",phone:"",email:"",role:"cashier",commission_rate:0,base_salary:0,status:"active",notes:""}),[i,B]=c.useState({username:"",password:"",confirmPassword:"",showPassword:!1,showConfirmPassword:!1}),[te,ae]=c.useState(!1),[U,K]=c.useState(!1),fe=c.useMemo(()=>{const s={};return x.trim()&&(s.search=x.trim()),m&&(s.role=m),q&&(s.status=q),s},[x,m,q]),{data:f,pagination:n,isLoading:u,error:A,refetch:k,handlePageChange:ie,handleLimitChange:le,page:Oe,limit:zs}=ys("/employees/simple",fe),oe=c.useMemo(()=>!f||f.length===0?{totalEmployees:0,activeEmployees:0,totalSalary:0,avgCommission:0}:{totalEmployees:n?.total||0,activeEmployees:f.filter(s=>s.status==="active").length,totalSalary:f.reduce((s,o)=>s+(o.base_salary||0),0),avgCommission:f.length>0?f.reduce((s,o)=>s+(o.commission_rate||0),0)/f.length:0},[f,n]),ke=s=>{s?(F(s),P({full_name:s.full_name,phone:s.phone||"",email:s.email||"",role:s.role,commission_rate:s.commission_rate||0,base_salary:s.base_salary||0,status:s.status,notes:s.notes||""})):(F(null),P({full_name:"",phone:"",email:"",role:"cashier",commission_rate:0,base_salary:0,status:"active",notes:""})),S(!0)},ce=()=>{S(!1),F(null)},Xe=async()=>{try{if(ae(!0),!d.full_name.trim()){h("Vui lòng nhập tên nhân viên",{variant:"error"});return}const s={...d,commission_rate:Number(d.commission_rate),base_salary:Number(d.base_salary)};z?(await w.put(`/employees/${z.id}`,s)).success&&(h("Cập nhật nhân viên thành công",{variant:"success"}),k(),ce()):(await w.post("/employees",s)).success&&(h("Tạo nhân viên thành công",{variant:"success"}),k(),ce())}catch(s){console.error("Submit employee error:",s),h("Lỗi khi lưu thông tin nhân viên",{variant:"error"})}finally{ae(!1)}},Ge=async s=>{if(confirm(`Bạn có chắc muốn xóa nhân viên "${s.full_name}"?`))try{(await w.delete(`/employees/${s.id}`)).success&&(h("Xóa nhân viên thành công",{variant:"success"}),k())}catch(o){console.error("Delete employee error:",o),h("Lỗi khi xóa nhân viên",{variant:"error"})}},Ue=()=>{b(""),H(""),X("active")},Ke=s=>{console.log("🔍 Opening password dialog for employee:",s),L(s),B({username:s.full_name.toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9]/g,"")||`user${s.id}`,password:"123456",confirmPassword:"",showPassword:!1,showConfirmPassword:!1}),y(!0),Ze(s)},Ze=async s=>{try{console.log(`🌐 Loading existing user data for employee ID: ${s.id}`);const o=await Ie.get(`https://smartpos-api.bangachieu2.workers.dev/api/v1/users/employee/${s.id}`,{headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0});if(console.log("📡 API Response:",o),o.data.success){const v=o.data.data;console.log("✅ Found existing user:",v),B(T=>({...T,username:v.username,password:"••••••••"}))}else console.log("❌ API returned error:",o.data.message)}catch(o){console.log("❌ API call failed:",o),console.log("No existing user found, will use defaults")}},ve=()=>{y(!1),L(null),B({username:"",password:"",confirmPassword:"",showPassword:!1,showConfirmPassword:!1})},J=(s,o)=>{B(v=>({...v,[s]:o}))},Ye=()=>i.username.trim()?i.username.length<3?(h("Tên đăng nhập phải có ít nhất 3 ký tự",{variant:"error"}),!1):/^[a-z0-9]+$/.test(i.username)?i.password?i.password.length<4?(h("Mật khẩu phải có ít nhất 4 ký tự",{variant:"error"}),!1):i.password!==i.confirmPassword?(h("Mật khẩu xác nhận không khớp",{variant:"error"}),!1):!0:(h("Vui lòng nhập mật khẩu",{variant:"error"}),!1):(h("Tên đăng nhập chỉ được chứa chữ cái thường và số",{variant:"error"}),!1):(h("Vui lòng nhập tên đăng nhập",{variant:"error"}),!1),Je=async()=>{if(!(!Ye()||!j))try{K(!0);const s=T=>{switch(T){case"admin":return"admin";case"sales_agent":return"sales_agent";case"cashier":return"cashier";case"affiliate":return"affiliate";case"inventory":return"inventory";default:return"cashier"}},o={username:i.username.trim(),password:i.password,email:j.email||`${i.username}@smartpos.com`,full_name:j.full_name,role:s(j.role),store_id:1,employee_id:j.id};console.log("🔐 Creating/Updating user account with payload:",o);const v=await Ie.post("https://smartpos-api.bangachieu2.workers.dev/api/v1/auth/register",o,{headers:{"Content-Type":"application/json",Accept:"application/json"},withCredentials:!0,timeout:15e3});if(console.log("✅ API response:",v.data),v.data&&v.data.success){const T=v.data.message||`Cập nhật tài khoản thành công cho ${j.full_name}`;h(T,{variant:"success"}),ve()}else{const T=v.data?.message||"Lỗi khi cập nhật tài khoản";console.error("❌ API returned error:",T),h(T,{variant:"error"})}}catch(s){console.error("💥 Create user account error:",s);let o="Lỗi khi cập nhật mật khẩu";s.response?o=s.response.data?.message||`Lỗi ${s.response.status}: ${s.response.statusText}`:s.request?o="Không thể kết nối đến server. Vui lòng thử lại.":o=s.message||"Lỗi không xác định",h(o,{variant:"error"})}finally{K(!1)}},es=async()=>{if(!f||f.length===0){h("Không có nhân viên nào để tạo tài khoản",{variant:"warning"});return}const s=`Bạn có chắc muốn tạo tài khoản đăng nhập cho tất cả ${f.length} nhân viên?

Mật khẩu mặc định sẽ là "123456"`;if(confirm(s))try{K(!0);const o=await w.post("/auth/create-users-from-employees");if(o.success){const{data:v}=o.data;h(`Tạo thành công ${v.users_created} tài khoản, ${v.users_existing} tài khoản đã tồn tại`,{variant:"success"}),v.login_info&&v.login_info.length>0&&(console.log("=== THÔNG TIN ĐĂNG NHẬP ==="),v.login_info.forEach(T=>{console.log(`${T.username}/123456 - ${T.employee_name} (${T.role})`)}),h(`Kiểm tra console để xem thông tin đăng nhập của ${v.login_info.length} tài khoản mới`,{variant:"info"}))}else h(o.message||"Lỗi khi tạo tài khoản",{variant:"error"})}catch(o){console.error("Create all user accounts error:",o),h(o.response?.data?.message||"Lỗi khi tạo tài khoản cho nhân viên",{variant:"error"})}finally{K(!1)}},ss=s=>{N(s),G(!0)},ns=()=>{G(!1),N(null)},rs=()=>{k()};return u&&!f?e.jsxs(a,{sx:{p:3},children:[e.jsx(Pe,{variant:"text",width:300,height:40}),e.jsx(l,{container:!0,spacing:3,sx:{mt:2},children:[1,2,3,4].map(s=>e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(Pe,{variant:"rectangular",height:120})},s))})]}):e.jsxs(a,{sx:{p:3},children:[e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(a,{children:[e.jsxs(t,{variant:"h4",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Se,{}),"Nhân viên & Hoa hồng"]}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Quản lý nhân viên bán hàng và hệ thống hoa hồng"})]}),e.jsxs(Te,{direction:"row",spacing:1,children:[e.jsx(p,{variant:"outlined",startIcon:e.jsx(Le,{}),onClick:k,disabled:u,children:"Làm mới"}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(he,{}),onClick:es,disabled:u||U,color:"secondary",children:"Tạo tài khoản cho tất cả"}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:()=>r(!0),color:"info",children:"Quản lý vai trò"}),e.jsx(p,{variant:"contained",startIcon:e.jsx(Me,{}),onClick:()=>ke(),children:"Thêm nhân viên"})]})]}),e.jsxs(l,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(W,{children:e.jsx($,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Tổng nhân viên"}),e.jsx(t,{variant:"h4",children:oe.totalEmployees})]}),e.jsx(Se,{color:"primary",sx:{fontSize:40}})]})})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(W,{children:e.jsx($,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Đang hoạt động"}),e.jsx(t,{variant:"h4",children:oe.activeEmployees})]}),e.jsx(Ne,{color:"success",sx:{fontSize:40}})]})})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(W,{children:e.jsx($,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Tổng lương cơ bản"}),e.jsx(t,{variant:"h4",children:bs(oe.totalSalary)})]}),e.jsx(ze,{color:"warning",sx:{fontSize:40}})]})})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(W,{children:e.jsx($,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Hoa hồng TB"}),e.jsxs(t,{variant:"h4",children:[oe.avgCommission.toFixed(1),"%"]})]}),e.jsx(ze,{color:"info",sx:{fontSize:40}})]})})})})]}),e.jsx(ee,{sx:{p:2,mb:2},children:e.jsxs(l,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(l,{item:!0,xs:12,sm:6,md:4,children:e.jsx(C,{fullWidth:!0,placeholder:"Tìm kiếm nhân viên...",value:x,onChange:s=>b(s.target.value),size:"small",InputProps:{startAdornment:e.jsx(se,{position:"start",children:e.jsx(Ts,{})})}})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(de,{fullWidth:!0,size:"small",children:[e.jsx(ue,{children:"Vai trò"}),e.jsxs(xe,{value:m,label:"Vai trò",onChange:s=>H(s.target.value),children:[e.jsx(I,{value:"",children:"Tất cả"}),e.jsx(I,{value:"admin",children:"Quản trị viên"}),e.jsx(I,{value:"cashier",children:"Thu ngân"}),e.jsx(I,{value:"sales_agent",children:"Nhân viên kinh doanh"}),e.jsx(I,{value:"affiliate",children:"Cộng tác viên"})]})]})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(de,{fullWidth:!0,size:"small",children:[e.jsx(ue,{children:"Trạng thái"}),e.jsxs(xe,{value:q,label:"Trạng thái",onChange:s=>X(s.target.value),children:[e.jsx(I,{value:"active",children:"Đang hoạt động"}),e.jsx(I,{value:"inactive",children:"Ngừng hoạt động"})]})]})}),e.jsx(l,{item:!0,xs:12,sm:6,md:2,children:e.jsx(p,{fullWidth:!0,variant:"outlined",onClick:Ue,size:"small",children:"Xóa bộ lọc"})})]})}),u?e.jsxs(ee,{sx:{p:2},children:[e.jsx(xs,{}),e.jsx(a,{sx:{mt:2},children:e.jsx(t,{variant:"body2",color:"text.secondary",children:"Đang tải dữ liệu nhân viên..."})})]}):A?e.jsxs(ee,{sx:{p:4,textAlign:"center"},children:[e.jsx(t,{color:"error",variant:"h6",gutterBottom:!0,children:"⚠️ Có lỗi xảy ra"}),e.jsx(t,{color:"text.secondary",sx:{mb:2},children:A}),e.jsx(p,{variant:"outlined",onClick:k,startIcon:e.jsx(Le,{}),children:"Thử lại"})]}):e.jsxs(ee,{children:[e.jsx(ms,{children:e.jsxs(js,{children:[e.jsx(gs,{children:e.jsxs(be,{children:[e.jsx(_,{children:"Nhân viên"}),e.jsx(_,{children:"Vai trò"}),e.jsx(_,{align:"right",children:"Lương cơ bản"}),e.jsx(_,{align:"center",children:"Hoa hồng"}),e.jsx(_,{align:"center",children:"Trạng thái"}),e.jsx(_,{align:"center",children:"Thao tác"})]})}),e.jsx(ps,{children:f&&f.length>0?f.map(s=>e.jsxs(be,{hover:!0,children:[e.jsx(_,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(fs,{sx:{mr:2,bgcolor:We(s.role)},children:s.full_name.charAt(0)}),e.jsxs(a,{children:[e.jsx(t,{variant:"subtitle2",fontWeight:"medium",children:s.full_name}),e.jsx(t,{variant:"body2",color:"text.secondary",children:s.email}),e.jsx(t,{variant:"body2",color:"text.secondary",children:s.phone})]})]})}),e.jsx(_,{children:e.jsx(R,{label:Re(s.role),color:We(s.role),size:"small",icon:Ls(s.role)})}),e.jsx(_,{align:"right",children:e.jsxs(t,{variant:"body2",fontWeight:"medium",children:[(s.base_salary||0).toLocaleString("vi-VN")," ₫"]})}),e.jsx(_,{align:"center",children:e.jsxs(t,{variant:"body2",fontWeight:"medium",color:"primary",children:[s.commission_rate||0,"%"]})}),e.jsx(_,{align:"center",children:e.jsx(R,{label:s.status==="active"?"Hoạt động":"Ngừng hoạt động",color:s.status==="active"?"success":"default",size:"small"})}),e.jsx(_,{align:"center",children:e.jsxs(Te,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(Z,{title:"Chỉnh sửa thông tin",children:e.jsx(E,{size:"small",onClick:()=>ke(s),color:"primary",children:e.jsx(Be,{})})}),e.jsx(Z,{title:"Quản lý tài khoản đăng nhập",children:e.jsx(E,{size:"small",onClick:()=>Ke(s),color:"secondary",children:e.jsx(he,{})})}),e.jsx(Z,{title:"Quản lý quyền hạn",children:e.jsx(E,{size:"small",onClick:()=>ss(s),color:"info",children:e.jsx(Y,{})})}),e.jsx(Z,{title:"Xóa nhân viên",children:e.jsx(E,{size:"small",onClick:()=>Ge(s),color:"error",children:e.jsx(qe,{})})})]})})]},s.id)):e.jsx(be,{children:e.jsx(_,{colSpan:6,align:"center",children:e.jsx(a,{sx:{py:4},children:e.jsx(t,{variant:"body1",color:"text.secondary",children:"Không có nhân viên nào"})})})})})]})}),n&&n.totalPages>1&&e.jsx(a,{sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(vs,{count:n.totalPages,page:Oe,onChange:(s,o)=>ie(o),color:"primary"})})]}),e.jsxs(me,{open:D,onClose:ce,maxWidth:"md",fullWidth:!0,children:[e.jsx(je,{children:z?"Sửa thông tin nhân viên":"Thêm nhân viên mới"}),e.jsx(ge,{children:e.jsxs(l,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Họ và tên",value:d.full_name,onChange:s=>P({...d,full_name:s.target.value}),required:!0})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Số điện thoại",value:d.phone,onChange:s=>P({...d,phone:s.target.value}),required:!0})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Email",type:"email",value:d.email,onChange:s=>P({...d,email:s.target.value}),required:!0})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsxs(de,{fullWidth:!0,required:!0,children:[e.jsx(ue,{children:"Vai trò"}),e.jsxs(xe,{value:d.role,label:"Vai trò",onChange:s=>P({...d,role:s.target.value}),children:[e.jsx(I,{value:"admin",children:"Quản trị viên"}),e.jsx(I,{value:"cashier",children:"Thu ngân"}),e.jsx(I,{value:"sales_agent",children:"Nhân viên kinh doanh"}),e.jsx(I,{value:"affiliate",children:"Cộng tác viên"})]})]})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Lương cơ bản (₫)",type:"number",value:d.base_salary,onChange:s=>P({...d,base_salary:parseInt(s.target.value)||0}),InputProps:{endAdornment:e.jsx(se,{position:"end",children:"₫"})}})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(C,{fullWidth:!0,label:"Tỷ lệ hoa hồng (%)",type:"number",value:d.commission_rate,onChange:s=>P({...d,commission_rate:parseFloat(s.target.value)||0}),InputProps:{endAdornment:e.jsx(se,{position:"end",children:"%"})},inputProps:{min:0,max:100,step:.1}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(C,{fullWidth:!0,label:"Ghi chú",multiline:!0,rows:3,value:d.notes,onChange:s=>P({...d,notes:s.target.value})})})]})}),e.jsxs(pe,{children:[e.jsx(p,{onClick:ce,children:"Hủy"}),e.jsx(p,{onClick:Xe,variant:"contained",disabled:te,startIcon:te?e.jsx(re,{size:20}):null,children:z?"Cập nhật":"Thêm mới"})]})]}),e.jsxs(me,{open:M,onClose:ve,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(je,{children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{}),"Quản lý tài khoản đăng nhập"]}),j&&e.jsxs(t,{variant:"body2",color:"text.secondary",children:["Chỉnh sửa tài khoản đăng nhập cho: ",j.full_name]})]}),e.jsx(ge,{children:e.jsxs(l,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(l,{item:!0,xs:12,children:e.jsx(C,{fullWidth:!0,label:"Tên đăng nhập",value:i.username,onChange:s=>J("username",s.target.value.toLowerCase().replace(/[^a-z0-9]/g,"")),helperText:"Tên đăng nhập phải có ít nhất 3 ký tự, chỉ chứa chữ cái và số",inputProps:{pattern:"[a-zA-Z0-9]+",minLength:3},placeholder:"Nhập tên đăng nhập mới"})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(C,{fullWidth:!0,label:"Mật khẩu",type:i.showPassword?"text":"password",value:i.password,onChange:s=>J("password",s.target.value),helperText:"Mật khẩu phải có ít nhất 4 ký tự",InputProps:{endAdornment:e.jsx(se,{position:"end",children:e.jsx(E,{onClick:()=>J("showPassword",!i.showPassword),edge:"end",children:i.showPassword?e.jsx(Ae,{}):e.jsx(Ee,{})})})},inputProps:{minLength:6}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(C,{fullWidth:!0,label:"Xác nhận mật khẩu",type:i.showConfirmPassword?"text":"password",value:i.confirmPassword,onChange:s=>J("confirmPassword",s.target.value),error:!!(i.confirmPassword&&i.password!==i.confirmPassword),helperText:i.confirmPassword&&i.password!==i.confirmPassword?"Mật khẩu xác nhận không khớp":"Nhập lại mật khẩu để xác nhận",InputProps:{endAdornment:e.jsx(se,{position:"end",children:e.jsx(E,{onClick:()=>J("showConfirmPassword",!i.showConfirmPassword),edge:"end",children:i.showConfirmPassword?e.jsx(Ae,{}):e.jsx(Ee,{})})})}})}),j&&e.jsx(l,{item:!0,xs:12,children:e.jsxs(ee,{sx:{p:2,bgcolor:"background.default"},children:[e.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"Thông tin tài khoản sẽ tạo:"}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:["• Họ tên: ",j.full_name]}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:["• Email: ",j.email||`${i.username}@smartpos.com`]}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:["• Vai trò: ",Re(j.role)]})]})})]})}),e.jsxs(pe,{children:[e.jsx(p,{onClick:ve,children:"Hủy"}),e.jsx(p,{onClick:Je,variant:"contained",disabled:U||!i.username||!i.password||i.password!==i.confirmPassword,startIcon:U?e.jsx(re,{size:20}):e.jsx(he,{}),children:U?"Đang cập nhật...":"Cập nhật tài khoản"})]})]}),e.jsx(Is,{open:Q,onClose:ns,employee:V,onPermissionsUpdated:rs}),e.jsx(Ss,{open:O,onClose:()=>r(!1),onRoleTemplateCreated:()=>{k()}})]})};export{qs as default};
