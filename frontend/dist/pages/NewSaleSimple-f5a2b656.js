import{e as K,p as Q,j as e,W as p,Y as $,Z as T,$ as l,T as s,V as G,I as A,a8 as V,C as F,t as k,E as we,A as fe,ak as He,al as Ne,am as Ue,ab as ve,aj as O,av as z,P as _e,aA as Me,L as Ve,w as Ke,a3 as re,af as Ce,ae as Z,ad as Qe,D as oe,ay as ae,o as ie,v as ce}from"../chunks/mui-core-cd9e8750.js";import{b as Se,u as Ye,r as u}from"../chunks/react-vendor-9ee90314.js";import{a as Je}from"../chunks/ui-vendor-11834b8a.js";import{b as I,a as ke}from"../assets/index-fad1ea34.js";import{S as X,aa as Ie,ab as Ze,D as Xe,f as et,t as tt,a3 as nt,i as st,e as rt,b as le,ac as ot,ad as at,j as it,T as Ae,ae as ct,af as lt,Z as dt,_ as ht,ag as xt}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/query-vendor-0e167262.js";import"../chunks/utils-vendor-8faa4a85.js";const gt=({customer:t,cartItemsCount:d,cartTotal:w,salesSummary:S,onCustomerSelect:o,onBarcodeScanner:j,onSettings:h,onSalesHistory:b,onDashboard:D,onRefresh:a,cashierName:m,storeName:f})=>{const W=K(),v=Q(W.breakpoints.down("md"));return e.jsxs(p,{sx:{mb:3},children:[e.jsx($,{sx:{mb:2},children:e.jsx(T,{sx:{pb:2},children:e.jsxs(l,{direction:v?"column":"row",justifyContent:"space-between",alignItems:v?"stretch":"center",spacing:2,children:[e.jsxs(p,{children:[e.jsxs(s,{variant:"h4",component:"h1",gutterBottom:!0,children:[e.jsx(X,{sx:{mr:1,verticalAlign:"middle"}}),"Điểm bán hàng"]}),e.jsxs(l,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Cửa hàng: ",e.jsx("strong",{children:f})]}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Thu ngân: ",e.jsx("strong",{children:m})]}),e.jsx(s,{variant:"body2",color:"text.secondary",children:new Date().toLocaleDateString("vi-VN")})]})]}),e.jsxs(l,{direction:"row",spacing:1,flexWrap:"wrap",children:[e.jsx(G,{title:"Quét mã vạch",children:e.jsx(A,{onClick:j,color:"primary",sx:{bgcolor:"primary.light",color:"white","&:hover":{bgcolor:"primary.main"}},children:e.jsx(Ie,{})})}),e.jsx(G,{title:"Lịch sử bán hàng",children:e.jsx(A,{onClick:b,color:"info",sx:{bgcolor:"info.light",color:"white","&:hover":{bgcolor:"info.main"}},children:e.jsx(Ze,{})})}),e.jsx(G,{title:"Dashboard",children:e.jsx(A,{onClick:D,color:"success",sx:{bgcolor:"success.light",color:"white","&:hover":{bgcolor:"success.main"}},children:e.jsx(Xe,{})})}),e.jsx(G,{title:"Cài đặt",children:e.jsx(A,{onClick:h,color:"secondary",sx:{bgcolor:"secondary.light",color:"white","&:hover":{bgcolor:"secondary.main"}},children:e.jsx(et,{})})}),e.jsx(G,{title:"Làm mới",children:e.jsx(A,{onClick:a,color:"default",children:e.jsx(tt,{})})})]})]})})}),e.jsxs(l,{direction:v?"column":"row",spacing:2,alignItems:v?"stretch":"center",children:[e.jsx($,{sx:{flexGrow:1},children:e.jsx(T,{sx:{py:1.5},children:e.jsxs(l,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(V,{sx:{bgcolor:t?"success.main":"grey.400"},children:e.jsx(nt,{})}),e.jsx(p,{sx:{flexGrow:1},children:t?e.jsxs(e.Fragment,{children:[e.jsx(s,{variant:"subtitle1",fontWeight:"bold",children:t.name}),e.jsxs(l,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:t.phone}),t.is_vip&&e.jsx(F,{label:"VIP",size:"small",color:"warning"}),e.jsxs(s,{variant:"body2",color:"primary",children:[t.loyalty_points," điểm"]})]})]}):e.jsx(s,{variant:"body1",color:"text.secondary",children:"Chưa chọn khách hàng"})}),e.jsx(k,{variant:t?"outlined":"contained",onClick:o,size:"small",children:t?"Đổi KH":"Chọn KH"})]})})}),e.jsx($,{children:e.jsx(T,{sx:{py:1.5},children:e.jsxs(l,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(V,{sx:{bgcolor:"primary.main"},children:e.jsx(X,{})}),e.jsxs(p,{children:[e.jsxs(s,{variant:"subtitle1",fontWeight:"bold",children:[d," sản phẩm"]}),e.jsx(s,{variant:"h6",color:"primary",fontWeight:"bold",children:I(w)})]})]})})}),S&&e.jsx($,{children:e.jsx(T,{sx:{py:1.5},children:e.jsxs(l,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(V,{sx:{bgcolor:"success.main"},children:e.jsx(st,{})}),e.jsxs(p,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"Hôm nay"}),e.jsxs(s,{variant:"subtitle1",fontWeight:"bold",children:[S.total_sales," đơn"]}),e.jsx(s,{variant:"body2",color:"success.main",fontWeight:"bold",children:I(S.total_amount)})]})]})})})]})]})},ut=({filters:t,onFiltersChange:d,categories:w,onBarcodeScanner:S,onClearFilters:o,productCount:j})=>{const h=K(),b=Q(h.breakpoints.down("sm")),D=i=>{d({...t,search:i.target.value})},a=i=>{d({...t,category_id:i.target.value||null})},m=i=>{const Y=t.sort_by===i&&t.sort_order==="asc"?"desc":"asc";d({...t,sort_by:i,sort_order:Y})},f=()=>{d({...t,in_stock_only:!t.in_stock_only})},v=(()=>{let i=0;return t.search&&i++,t.category_id&&i++,t.in_stock_only&&i++,(t.price_range.min>0||t.price_range.max<999999999)&&i++,i})();return e.jsxs(p,{sx:{mb:3},children:[e.jsxs(l,{direction:b?"column":"row",spacing:2,alignItems:b?"stretch":"center",sx:{mb:2},children:[e.jsx(we,{placeholder:"Tìm kiếm sản phẩm, SKU, mã vạch...",value:t.search,onChange:D,InputProps:{startAdornment:e.jsx(fe,{position:"start",children:e.jsx(rt,{})}),endAdornment:t.search&&e.jsx(fe,{position:"end",children:e.jsx(A,{size:"small",onClick:()=>d({...t,search:""}),children:e.jsx(le,{})})})},sx:{flexGrow:1},size:"small"}),e.jsxs(He,{size:"small",sx:{minWidth:150},children:[e.jsx(Ne,{children:"Danh mục"}),e.jsxs(Ue,{value:t.category_id||"",onChange:a,label:"Danh mục",children:[e.jsx(ve,{value:"",children:"Tất cả"}),Array.isArray(w)&&w.map(i=>e.jsxs(ve,{value:i.id,children:[i.name,i.product_count&&` (${i.product_count})`]},i.id))]})]}),e.jsx(G,{title:"Quét mã vạch",children:e.jsx(k,{variant:"outlined",startIcon:e.jsx(Ie,{}),onClick:S,size:"small",children:b?"":"Quét mã"})})]}),e.jsxs(l,{direction:b?"column":"row",spacing:1,alignItems:b?"stretch":"center",justifyContent:"space-between",children:[e.jsxs(l,{direction:"row",spacing:1,flexWrap:"wrap",children:[e.jsx(F,{label:"Còn hàng",variant:t.in_stock_only?"filled":"outlined",onClick:f,color:t.in_stock_only?"primary":"default",size:"small"}),v>0&&e.jsx(F,{label:`${v} bộ lọc`,onDelete:o,color:"secondary",size:"small",deleteIcon:e.jsx(le,{})}),e.jsx(F,{label:`${j} sản phẩm`,variant:"outlined",size:"small",color:"info"})]}),e.jsxs(l,{direction:"row",spacing:1,children:[e.jsxs(k,{variant:t.sort_by==="name"?"contained":"outlined",onClick:()=>m("name"),size:"small",startIcon:e.jsx(ot,{}),children:["Tên ",t.sort_by==="name"&&(t.sort_order==="asc"?"↑":"↓")]}),e.jsxs(k,{variant:t.sort_by==="price"?"contained":"outlined",onClick:()=>m("price"),size:"small",children:["Giá ",t.sort_by==="price"&&(t.sort_order==="asc"?"↑":"↓")]}),e.jsxs(k,{variant:t.sort_by==="stock"?"contained":"outlined",onClick:()=>m("stock"),size:"small",children:["Tồn ",t.sort_by==="stock"&&(t.sort_order==="asc"?"↑":"↓")]})]})]})]})},mt=Se.memo(({products:t,onAddToCart:d,onProductDetails:w,loading:S,searchTerm:o})=>{const j=K(),h=Q(j.breakpoints.down("sm")),b=(a,m=10)=>a<=0?{label:"Hết hàng",color:"error"}:a<=m?{label:"Sắp hết",color:"warning"}:{label:"Còn hàng",color:"success"},D=(a,m)=>{if(!m)return a;const f=new RegExp(`(${m})`,"gi");return a.split(f).map((v,i)=>f.test(v)?e.jsx("mark",{style:{backgroundColor:j.palette.warning.light,borderRadius:"4px",padding:"2px 4px"},children:v},i):v)};return S?e.jsx(O,{container:!0,spacing:2,children:Array.from({length:8}).map((a,m)=>e.jsx(O,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs($,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsx(z,{variant:"rectangular",height:140,animation:"wave",sx:{borderRadius:"4px 4px 0 0"}}),e.jsxs(T,{sx:{flexGrow:1},children:[e.jsx(z,{variant:"text",height:28,width:"80%",sx:{mb:1}}),e.jsx(z,{variant:"text",height:20,width:"60%",sx:{mb:1}}),e.jsx(z,{variant:"text",height:20,width:"40%",sx:{mb:2}}),e.jsxs(l,{direction:"row",spacing:1,alignItems:"center",sx:{mb:2},children:[e.jsx(z,{variant:"circular",width:20,height:20}),e.jsx(z,{variant:"text",height:20,width:"50%"})]}),e.jsx(z,{variant:"text",height:32,width:"70%",sx:{mb:1}}),e.jsx(z,{variant:"rectangular",height:36,width:"100%"})]})]})},m))}):Array.isArray(t)?t.length===0?e.jsxs(_e,{elevation:0,sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:8,px:4,textAlign:"center",bgcolor:"grey.50",borderRadius:2,border:"2px dashed",borderColor:"grey.300"},children:[e.jsx(V,{sx:{width:80,height:80,bgcolor:"primary.light",mb:3},children:e.jsx(X,{sx:{fontSize:40}})}),e.jsx(s,{variant:"h5",color:"text.primary",gutterBottom:!0,fontWeight:"bold",children:o?"Không tìm thấy sản phẩm":"Chưa có sản phẩm"}),e.jsx(s,{variant:"body1",color:"text.secondary",sx:{mb:2},children:o?`Không có sản phẩm nào phù hợp với từ khóa "${o}"`:"Danh sách sản phẩm trống. Vui lòng kiểm tra kết nối API."}),e.jsx(s,{variant:"body2",color:"text.secondary",children:o?"Hãy thử tìm kiếm với từ khóa khác hoặc kiểm tra lại chính tả":"Kiểm tra kết nối đến Cloudflare D1 database"})]}):e.jsx(O,{container:!0,spacing:2,children:t.map(a=>{const m=b(a.stock_quantity,a.min_stock_level),f=a.stock_quantity<=0;return e.jsx(O,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs($,{sx:{height:"100%",display:"flex",flexDirection:"column",position:"relative",opacity:f?.7:1,transition:"all 0.2s ease-in-out","&:hover":{transform:"translateY(-2px)",boxShadow:j.shadows[4]}},children:[e.jsxs(p,{sx:{position:"relative"},children:[e.jsx(Me,{component:"img",height:"140",image:a.image_url||"/placeholder-product.jpg",alt:a.name,sx:{objectFit:"cover",cursor:"pointer"},onClick:()=>w(a)}),e.jsx(F,{label:m.label,color:m.color,size:"small",sx:{position:"absolute",top:8,right:8,fontWeight:"bold"}}),a.discount_eligible&&e.jsx(F,{icon:e.jsx(at,{}),label:"Giảm giá",color:"secondary",size:"small",sx:{position:"absolute",top:8,left:8,fontWeight:"bold"}})]}),e.jsxs(T,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[e.jsxs(p,{sx:{flexGrow:1},children:[e.jsx(s,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,sx:{cursor:"pointer","&:hover":{color:"primary.main"}},onClick:()=>w(a),children:D(a.name,o)}),e.jsxs(s,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:["SKU: ",a.sku]}),a.category_name&&e.jsx(s,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:a.category_name}),e.jsxs(l,{direction:"row",spacing:1,alignItems:"center",sx:{mt:1},children:[e.jsx(it,{fontSize:"small",color:"action"}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:[a.stock_quantity," có sẵn"]})]})]}),e.jsxs(p,{children:[e.jsx(s,{variant:"h6",color:"primary",fontWeight:"bold",gutterBottom:!0,children:I(a.price)}),e.jsxs(l,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(k,{variant:"contained",startIcon:e.jsx(Ae,{}),onClick:()=>d(a),disabled:f,fullWidth:!0,size:h?"small":"medium",children:f?"Hết hàng":"Thêm"}),e.jsx(G,{title:"Chi tiết sản phẩm",children:e.jsx(A,{onClick:()=>w(a),color:"primary",size:"small",children:e.jsx(ct,{})})})]})]})]})]})},a.id)})}):(console.error("Products is not an array:",t),e.jsxs(_e,{elevation:0,sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:8,px:4,textAlign:"center",bgcolor:"error.light",borderRadius:2},children:[e.jsx(s,{variant:"h6",color:"error.main",gutterBottom:!0,children:"Lỗi dữ liệu sản phẩm"}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Dữ liệu không đúng định dạng. Vui lòng kiểm tra API."})]}))}),pt=({items:t,customer:d,subtotal:w,discountAmount:S,taxAmount:o,total:j,onUpdateQuantity:h,onRemoveItem:b,onClearCart:D,onApplyDiscount:a,onEditItem:m,onCheckout:f,loading:W})=>{const v=K(),i=Q(v.breakpoints.down("md")),Y=t.reduce((x,q)=>x+q.quantity,0);return t.length===0?e.jsx($,{sx:{height:"100%"},children:e.jsx(T,{children:e.jsxs(p,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:4,textAlign:"center"},children:[e.jsx(V,{sx:{width:64,height:64,bgcolor:"grey.300",mb:2},children:e.jsx(X,{sx:{fontSize:32}})}),e.jsx(s,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"Giỏ hàng trống"}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"Thêm sản phẩm vào giỏ hàng để bắt đầu"})]})})}):e.jsx($,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:e.jsxs(T,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[e.jsxs(l,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:2},children:[e.jsxs(s,{variant:"h6",fontWeight:"bold",children:["Giỏ hàng (",Y," sản phẩm)"]}),e.jsx(k,{startIcon:e.jsx(le,{}),onClick:D,color:"error",size:"small",variant:"outlined",children:"Xóa tất cả"})]}),e.jsx(p,{sx:{flexGrow:1,overflow:"auto",maxHeight:400},children:e.jsx(Ve,{dense:!0,children:Array.isArray(t)&&t.length>0?t.map((x,q)=>e.jsxs(Se.Fragment,{children:[e.jsxs(Ke,{sx:{px:0,py:1,alignItems:"flex-start"},children:[e.jsxs(p,{sx:{flexGrow:1},children:[e.jsx(s,{variant:"subtitle2",fontWeight:"bold",children:x.product.name}),e.jsxs(s,{variant:"body2",color:"text.secondary",children:[I(x.unit_price)," x ",x.quantity]}),x.discount_amount>0&&e.jsx(F,{label:`Giảm ${I(x.discount_amount)}`,size:"small",color:"secondary",sx:{mt:.5}}),e.jsxs(l,{direction:"row",alignItems:"center",spacing:1,sx:{mt:1},children:[e.jsx(A,{size:"small",onClick:()=>h(x.id,x.quantity-1),disabled:x.quantity<=1,children:e.jsx(lt,{fontSize:"small"})}),e.jsx(we,{value:x.quantity,onChange:ee=>{const H=parseInt(ee.target.value)||1;h(x.id,H)},size:"small",sx:{width:60},inputProps:{style:{textAlign:"center"},min:1,type:"number"}}),e.jsx(A,{size:"small",onClick:()=>h(x.id,x.quantity+1),disabled:x.quantity>=x.product.stock_quantity,children:e.jsx(Ae,{fontSize:"small"})})]})]}),e.jsxs(p,{sx:{textAlign:"right",ml:2},children:[e.jsx(s,{variant:"subtitle1",fontWeight:"bold",children:I(x.total_amount)}),e.jsxs(l,{direction:"row",spacing:.5,sx:{mt:1},children:[e.jsx(A,{size:"small",onClick:()=>m(x),color:"primary",children:e.jsx(dt,{fontSize:"small"})}),e.jsx(A,{size:"small",onClick:()=>b(x.id),color:"error",children:e.jsx(ht,{fontSize:"small"})})]})]})]}),q<t.length-1&&e.jsx(re,{})]},x.id)):e.jsxs(p,{sx:{textAlign:"center",py:4},children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"Giỏ hàng trống"}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Thêm sản phẩm để bắt đầu bán hàng"})]})})}),e.jsx(re,{sx:{my:2}}),e.jsxs(p,{children:[e.jsxs(l,{spacing:1,children:[e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(s,{variant:"body2",children:"Tạm tính:"}),e.jsx(s,{variant:"body2",children:I(w)})]}),S>0&&e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(s,{variant:"body2",color:"secondary",children:"Giảm giá:"}),e.jsxs(s,{variant:"body2",color:"secondary",children:["-",I(S)]})]}),o>0&&e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(s,{variant:"body2",children:"Thuế:"}),e.jsx(s,{variant:"body2",children:I(o)})]}),e.jsx(re,{}),e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(s,{variant:"h6",fontWeight:"bold",children:"Tổng cộng:"}),e.jsx(s,{variant:"h6",fontWeight:"bold",color:"primary",children:I(j)})]})]}),d?.discount_percentage&&e.jsx(p,{sx:{mt:2,p:1,bgcolor:"success.light",borderRadius:1},children:e.jsxs(s,{variant:"body2",color:"success.dark",children:["Khách hàng VIP: Giảm ",d.discount_percentage,"%"]})}),e.jsxs(l,{spacing:1,sx:{mt:2},children:[e.jsx(k,{variant:"outlined",onClick:a,fullWidth:!0,size:i?"small":"medium",children:"Áp dụng giảm giá"}),e.jsxs(k,{variant:"contained",startIcon:e.jsx(xt,{}),onClick:f,disabled:W||t.length===0,fullWidth:!0,size:i?"medium":"large",sx:{py:1.5},children:["Thanh toán (",I(j),")"]})]})]})]})})},wt=()=>{const t=Ye(),{enqueueSnackbar:d}=Je(),w=K(),S=Q(w.breakpoints.down("lg")),[o,j]=u.useState({cart:[],payments:[],discount:{type:"none",value:0,amount:0},tax:{rate:10,amount:0},subtotal:0,total:0,paid_amount:0,change_amount:0,receipt_number:"",notes:"",status:"draft"}),[h,b]=u.useState({search:"",category_id:null,in_stock_only:!0,price_range:{min:0,max:999999999},sort_by:"name",sort_order:"asc"}),[D,a]=u.useState([]),[m,f]=u.useState(null),[W,v]=u.useState(!1),[i,Y]=u.useState(null),[x,q]=u.useState(!1),[ee,H]=u.useState(!1),[De,te]=u.useState(!1),[E,ne]=u.useState([]),[de,he]=u.useState(!0),[L,se]=u.useState(null),xe=async()=>{console.log("🚀 fetchProducts called!");try{he(!0),se(null);const n={search:h.search,category_id:h.category_id,in_stock_only:h.in_stock_only,sort_by:h.sort_by,sort_order:h.sort_order,limit:50},c=Object.entries(n).reduce((P,[R,C])=>(C!=null&&C!==""&&(P[R]=C),P),{});console.log("🔍 Fetching products with params:",c);const _=`https://smartpos-api.bangachieu2.workers.dev/api/v1/products?${new URLSearchParams(c).toString()}`;console.log("🌐 Fetching from URL:",_);const g=await(await fetch(_)).json();if(console.log("📦 Products API response:",g),g.success){let P=[];g.data&&typeof g.data=="object"?Array.isArray(g.data)?(console.log("✅ Using old format, products count:",g.data.length),P=g.data):g.data.data&&Array.isArray(g.data.data)?(console.log("✅ Using new format, products count:",g.data.data.length),P=g.data.data):console.warn("⚠️ Unexpected data format:",g.data):console.warn("⚠️ No data in response:",g);const R=P.map(r=>({id:r.id,name:r.name,sku:r.sku,barcode:r.barcode,price:r.price,cost_price:r.costPrice||r.cost_price||0,stock_quantity:r.stockQuantity||r.stock_quantity||0,min_stock_level:r.stockAlertThreshold||r.min_stock_level||0,category_id:r.categoryId||r.category_id||0,category_name:r.categoryName||r.category_name,image_url:r.imageUrl||r.image_url,is_active:r.isActive!==void 0?r.isActive:r.is_active!==void 0?r.is_active:!0,brand:r.brand,description:r.description,discount_eligible:r.discount_eligible||!1}));console.log("🎯 Final products array:",R),console.log("📊 Setting data with",R.length,"products");let C=Array.isArray(R)?[...R]:[];console.log("🔄 FORCE applying client-side sort:",h.sort_by,h.sort_order),console.log("📋 Products before sort:",C.map(r=>`${r.name} - ${r.price}`)),C.sort((r,U)=>{let B,M;switch(h.sort_by){case"price":B=parseFloat(String(r.price))||0,M=parseFloat(String(U.price))||0;break;case"name":B=(r.name||"").toLowerCase(),M=(U.name||"").toLowerCase();break;case"stock":B=parseInt(String(r.stock_quantity))||0,M=parseInt(String(U.stock_quantity))||0;break;default:return 0}let J;return typeof B=="string"?J=B.localeCompare(M):J=B-M,h.sort_order==="desc"?-J:J}),console.log("✅ Client-side sort completed!"),console.log("📋 Products after sort:",C.map(r=>`${r.name} - ${r.price}`)),console.log("🎯 First 3 products:"),C.slice(0,3).forEach((r,U)=>{console.log(`${U+1}. ${r.name} - ${r.price?.toLocaleString("vi-VN")} ₫`)}),console.log("🚀 Setting sorted products in NewSaleSimple:",C),ne(C),localStorage.setItem("smartpos_products",JSON.stringify(C)),C.length>0&&(console.log("✅ Clearing error state because we have",C.length,"products"),se(null)),console.log("✅ Data set successfully")}else console.error("❌ API returned success: false",g),console.log("⚠️ Setting empty array to avoid blocking UI"),ne([])}catch(n){console.error("💥 Error fetching products:",n),console.log("⚠️ Setting empty array to avoid blocking UI"),ne([])}finally{he(!1)}},Pe=()=>{console.log("🔄 refetchProducts called"),xe()};u.useEffect(()=>{xe()},[JSON.stringify(h)]),u.useEffect(()=>{E.length>0&&L&&(console.log("🔧 Force clearing error because we have",E.length,"products but error is:",L),se(null))},[E.length,L]),u.useEffect(()=>{ge(),ue(),me()},[]),u.useEffect(()=>{ze()},[o.cart,o.discount,o.tax]);const ge=async()=>{try{const n=await ke.get("/categories",{withCredentials:!0});if(n.data.success){let c=[];n.data.data&&typeof n.data.data=="object"&&(Array.isArray(n.data.data)?c=n.data.data:n.data.data.data&&Array.isArray(n.data.data.data)&&(c=n.data.data.data)),a(Array.isArray(c)?c:[])}else a([])}catch(n){console.error("Categories fetch error:",n),a([])}},ue=async()=>{try{const n=new Date().toISOString().split("T")[0],c=await ke.get(`/sales/summary?date=${n}`);f(c)}catch(n){console.error("Sales summary fetch error:",n)}},me=()=>{const n=new Date,c=`POS${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,"0")}${n.getDate().toString().padStart(2,"0")}${n.getHours().toString().padStart(2,"0")}${n.getMinutes().toString().padStart(2,"0")}${n.getSeconds().toString().padStart(2,"0")}`;j(y=>({...y,receipt_number:c}))},ze=()=>{const n=o.cart.reduce((g,P)=>g+P.total_amount,0),c=o.discount.type==="percentage"?n*(o.discount.value/100):o.discount.value,y=n-c,_=y*(o.tax.rate/100),N=y+_;j(g=>({...g,subtotal:n,discount:{...g.discount,amount:c},tax:{...g.tax,amount:_},total:N}))},$e=u.useCallback(n=>{const c=o.cart.find(y=>y.product_id===n.id);if(c)pe(c.id,c.quantity+1);else{const y={id:`cart_${Date.now()}_${n.id}`,product_id:n.id,product:n,quantity:1,unit_price:n.price,discount_amount:0,discount_percentage:0,tax_amount:n.price*((o.tax.rate||0)/100),total_amount:n.price};j(_=>({..._,cart:[..._.cart,y]}))}d(`Đã thêm ${n.name} vào giỏ hàng`,{variant:"success"})},[o.cart,o.tax.rate,d]),pe=u.useCallback((n,c)=>{if(c<=0){je(n);return}j(y=>({...y,cart:y.cart.map(_=>{if(_.id===n){const N=_.unit_price*c-_.discount_amount;return{..._,quantity:c,total_amount:N,tax_amount:N*((y.tax.rate||0)/100)}}return _})}))},[]),je=u.useCallback(n=>{j(c=>({...c,cart:c.cart.filter(y=>y.id!==n)})),d("Đã xóa sản phẩm khỏi giỏ hàng",{variant:"info"})},[d]),Te=u.useCallback(()=>{j(n=>({...n,cart:[],customer:void 0,payments:[],discount:{type:"none",value:0,amount:0}})),me(),d("Đã xóa tất cả sản phẩm",{variant:"info"})},[d]),We=()=>{q(!0)},ye=()=>{H(!0)},qe=n=>{t(`/products/${n.id}`)},Ee=()=>{d("Chức năng giảm giá sẽ được triển khai sớm",{variant:"info"})},Ge=n=>{d("Chức năng chỉnh sửa sẽ được triển khai sớm",{variant:"info"})},Oe=()=>{if(o.cart.length===0){d("Giỏ hàng trống",{variant:"warning"});return}te(!0)},Fe=()=>{t("/settings")},Le=()=>{t("/sales")},Re=()=>{t("/dashboard")},be=()=>{Pe(),ge(),ue()},Be=()=>{b({search:"",category_id:null,in_stock_only:!0,price_range:{min:0,max:999999999},sort_by:"name",sort_order:"asc"})};return(i||L)&&E.length===0?(console.log("❌ Showing error UI because:",{error:i,productsError:L,productsLength:E.length}),e.jsxs(Ce,{maxWidth:"xl",sx:{py:3},children:[e.jsx(Z,{severity:"error",sx:{mb:2},children:i||L}),e.jsx(k,{onClick:be,variant:"contained",children:"Thử lại"})]})):e.jsxs(Ce,{maxWidth:"xl",sx:{py:3},children:[e.jsx(gt,{customer:o.customer,cartItemsCount:o.cart.reduce((n,c)=>n+c.quantity,0),cartTotal:o.total,salesSummary:m,onCustomerSelect:We,onBarcodeScanner:ye,onSettings:Fe,onSalesHistory:Le,onDashboard:Re,onRefresh:be,cashierName:"Admin",storeName:"Cửa hàng chính"}),e.jsxs(O,{container:!0,spacing:3,children:[e.jsxs(O,{item:!0,xs:12,lg:S?12:8,children:[e.jsx(ut,{filters:h,onFiltersChange:b,categories:D,onBarcodeScanner:ye,onClearFilters:Be,productCount:E?.length||0}),de&&e.jsx(p,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(Qe,{})}),e.jsx(mt,{products:E||[],onAddToCart:$e,onProductDetails:qe,loading:de,searchTerm:h.search})]}),e.jsx(O,{item:!0,xs:12,lg:4,children:e.jsx(p,{sx:{position:"sticky",top:20},children:e.jsx(pt,{items:o.cart,customer:o.customer,subtotal:o.subtotal,discountAmount:o.discount.amount,taxAmount:o.tax.amount,total:o.total,onUpdateQuantity:pe,onRemoveItem:je,onClearCart:Te,onApplyDiscount:Ee,onEditItem:Ge,onCheckout:Oe,loading:W})})})]}),e.jsxs(oe,{open:x,onClose:()=>q(!1),children:[e.jsx(ae,{children:"Chọn khách hàng"}),e.jsx(ie,{children:e.jsx(Z,{severity:"info",children:"Chức năng chọn khách hàng sẽ được triển khai trong phiên bản tiếp theo"})}),e.jsx(ce,{children:e.jsx(k,{onClick:()=>q(!1),children:"Đóng"})})]}),e.jsxs(oe,{open:ee,onClose:()=>H(!1),children:[e.jsx(ae,{children:"Quét mã vạch"}),e.jsx(ie,{children:e.jsx(Z,{severity:"info",children:"Chức năng quét mã vạch sẽ được triển khai trong phiên bản tiếp theo"})}),e.jsx(ce,{children:e.jsx(k,{onClick:()=>H(!1),children:"Đóng"})})]}),e.jsxs(oe,{open:De,onClose:()=>te(!1),children:[e.jsx(ae,{children:"Thanh toán"}),e.jsx(ie,{children:e.jsx(Z,{severity:"info",children:"Chức năng thanh toán sẽ được triển khai trong phiên bản tiếp theo"})}),e.jsx(ce,{children:e.jsx(k,{onClick:()=>te(!1),children:"Đóng"})})]})]})};export{wt as default};
