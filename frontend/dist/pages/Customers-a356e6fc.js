import{e as Q,p as U,j as e,W as l,$ as w,T as r,t as j,aj as y,Y as ge,Z as me,C as z,E as f,A as we,ak as $,al as F,am as R,ab as o,a0 as Te,a8 as ae,I as re,ap as Se,P as We,aq as ze,ar as De,as as le,at as h,au as Pe,aa as Ee,af as ie,ae as Le,a3 as Be,ad as $e,ax as Fe,D as oe,ay as ce,o as he,v as de}from"../chunks/mui-core-cd9e8750.js";import{b as V,u as Re,r as p}from"../chunks/react-vendor-9ee90314.js";import{a as Ae}from"../chunks/ui-vendor-11834b8a.js";import{u as Me}from"../chunks/useApiData-60d9f817.js";import{b as X,a as B}from"../assets/index-fad1ea34.js";import{P as xe,x as He,ae as N,y as Ke,t as Oe,aV as qe,a2 as Ge,T as Ve,e as Xe,U as Ne,c as Qe,d as Ue,b as Ze,B as q,a3 as G,a5 as ue,ao as Ye,aj as Je,aB as en,Z as nn,_ as sn}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/utils-vendor-8faa4a85.js";import"../chunks/query-vendor-0e167262.js";const tn=({stats:t,onAddCustomer:i,onImport:d,onExport:_,onRefresh:P,loading:u})=>{const v=Q(),g=U(v.breakpoints.down("sm")),k=[{title:"Tổng khách hàng",value:t?.total_customers||0,icon:e.jsx(xe,{}),color:"primary"},{title:"Khách hàng hoạt động",value:t?.active_customers||0,icon:e.jsx(He,{}),color:"success"},{title:"Khách hàng mới (tháng)",value:t?.new_customers_this_month||0,icon:e.jsx(N,{}),color:"info"},{title:"Giá trị đơn hàng TB",value:X(t?.average_order_value||0),icon:e.jsx(Ke,{}),color:"warning"}];return e.jsxs(l,{sx:{mb:3},children:[e.jsxs(w,{direction:g?"column":"row",justifyContent:"space-between",alignItems:g?"stretch":"center",spacing:2,sx:{mb:3},children:[e.jsxs(l,{children:[e.jsxs(r,{variant:"h4",component:"h1",gutterBottom:!0,children:[e.jsx(xe,{sx:{mr:1,verticalAlign:"middle"}}),"Quản lý khách hàng"]}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Quản lý thông tin và theo dõi hoạt động của khách hàng"})]}),e.jsxs(w,{direction:g?"column":"row",spacing:1,children:[e.jsx(j,{startIcon:e.jsx(Oe,{}),onClick:P,variant:"outlined",disabled:u,size:g?"small":"medium",children:"Làm mới"}),e.jsx(j,{startIcon:e.jsx(qe,{}),onClick:d,variant:"outlined",disabled:u,size:g?"small":"medium",children:"Nhập Excel"}),e.jsx(j,{startIcon:e.jsx(Ge,{}),onClick:_,variant:"outlined",disabled:u,size:g?"small":"medium",children:"Xuất dữ liệu"}),e.jsx(j,{startIcon:e.jsx(Ve,{}),onClick:i,variant:"contained",disabled:u,size:g?"small":"medium",children:"Thêm khách hàng"})]})]}),e.jsx(y,{container:!0,spacing:2,children:k.map((c,I)=>e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(ge,{sx:{background:`linear-gradient(135deg, ${v.palette[c.color].light}, ${v.palette[c.color].main})`,color:"white",height:"100%"},children:e.jsx(me,{children:e.jsxs(w,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(l,{sx:{p:1,borderRadius:2,bgcolor:"rgba(255, 255, 255, 0.2)",display:"flex",alignItems:"center",justifyContent:"center"},children:c.icon}),e.jsxs(l,{sx:{flexGrow:1},children:[e.jsx(r,{variant:"body2",sx:{opacity:.9},children:c.title}),e.jsx(r,{variant:"h5",fontWeight:"bold",children:c.value})]})]})})})},I))}),t&&e.jsx(l,{sx:{mt:2,p:2,bgcolor:"background.paper",borderRadius:2},children:e.jsxs(w,{direction:"row",spacing:4,flexWrap:"wrap",children:[e.jsxs(l,{children:[e.jsx(r,{variant:"body2",color:"text.secondary",children:"Tỷ lệ tăng trưởng"}),e.jsx(z,{label:`${t.customer_growth_rate>0?"+":""}${t.customer_growth_rate.toFixed(1)}%`,color:t.customer_growth_rate>0?"success":"error",size:"small"})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"body2",color:"text.secondary",children:"Tỷ lệ giữ chân"}),e.jsx(z,{label:`${t.retention_rate.toFixed(1)}%`,color:t.retention_rate>70?"success":t.retention_rate>50?"warning":"error",size:"small"})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"body2",color:"text.secondary",children:"Tổng điểm thưởng"}),e.jsxs(r,{variant:"body1",fontWeight:"medium",children:[t.total_loyalty_points.toLocaleString()," điểm"]})]})]})})]})},an=({filters:t,onFiltersChange:i,cities:d,onClearFilters:_})=>{const P=Q(),u=U(P.breakpoints.down("sm")),[v,g]=V.useState(!1),k=a=>{i({...t,search:a.target.value})},c=a=>{i({...t,customer_type:a.target.value})},I=a=>{i({...t,status:a.target.value})},E=a=>{i({...t,city:a.target.value})},b=a=>{i({...t,loyalty_tier:a.target.value})},C=(a,n)=>{i({...t,date_range:{...t.date_range,[a]:n}})},D=(()=>{let a=0;return t.search&&a++,t.customer_type!=="all"&&a++,t.status!=="all"&&a++,t.city&&a++,t.loyalty_tier!=="all"&&a++,(t.date_range.start||t.date_range.end)&&a++,a})();return e.jsxs(l,{sx:{mb:3},children:[e.jsxs(w,{direction:u?"column":"row",spacing:2,alignItems:u?"stretch":"center",sx:{mb:2},children:[e.jsx(f,{placeholder:"Tìm kiếm khách hàng...",value:t.search,onChange:k,InputProps:{startAdornment:e.jsx(we,{position:"start",children:e.jsx(Xe,{})})},sx:{flexGrow:1,minWidth:u?"auto":300},size:"small"}),e.jsxs($,{size:"small",sx:{minWidth:150},children:[e.jsx(F,{children:"Loại khách hàng"}),e.jsxs(R,{value:t.customer_type,onChange:c,label:"Loại khách hàng",children:[e.jsx(o,{value:"all",children:"Tất cả"}),e.jsx(o,{value:"individual",children:"Cá nhân"}),e.jsx(o,{value:"business",children:"Doanh nghiệp"})]})]}),e.jsxs($,{size:"small",sx:{minWidth:120},children:[e.jsx(F,{children:"Trạng thái"}),e.jsxs(R,{value:t.status,onChange:I,label:"Trạng thái",children:[e.jsx(o,{value:"all",children:"Tất cả"}),e.jsx(o,{value:"active",children:"Hoạt động"}),e.jsx(o,{value:"inactive",children:"Không hoạt động"}),e.jsx(o,{value:"blocked",children:"Bị chặn"})]})]}),e.jsxs(j,{startIcon:e.jsx(Ne,{}),endIcon:v?e.jsx(Qe,{}):e.jsx(Ue,{}),onClick:()=>g(!v),variant:"outlined",size:"small",children:["Bộ lọc ",D>0&&e.jsx(z,{label:D,size:"small",color:"primary",sx:{ml:1}})]}),D>0&&e.jsx(j,{startIcon:e.jsx(Ze,{}),onClick:_,variant:"text",size:"small",color:"error",children:"Xóa bộ lọc"})]}),e.jsx(Te,{in:v,children:e.jsx(l,{sx:{p:2,bgcolor:"background.paper",borderRadius:2,border:1,borderColor:"divider"},children:e.jsxs(w,{direction:u?"column":"row",spacing:2,alignItems:u?"stretch":"center",children:[e.jsxs($,{size:"small",sx:{minWidth:150},children:[e.jsx(F,{children:"Thành phố"}),e.jsxs(R,{value:t.city,onChange:E,label:"Thành phố",children:[e.jsx(o,{value:"",children:"Tất cả"}),d.map(a=>e.jsx(o,{value:a,children:a},a))]})]}),e.jsxs($,{size:"small",sx:{minWidth:150},children:[e.jsx(F,{children:"Hạng thành viên"}),e.jsxs(R,{value:t.loyalty_tier,onChange:b,label:"Hạng thành viên",children:[e.jsx(o,{value:"all",children:"Tất cả"}),e.jsx(o,{value:"bronze",children:"Đồng"}),e.jsx(o,{value:"silver",children:"Bạc"}),e.jsx(o,{value:"gold",children:"Vàng"}),e.jsx(o,{value:"platinum",children:"Bạch kim"})]})]}),e.jsx(f,{label:"Từ ngày",type:"date",value:t.date_range.start||"",onChange:a=>C("start",a.target.value),InputLabelProps:{shrink:!0},size:"small",sx:{minWidth:150}}),e.jsx(f,{label:"Đến ngày",type:"date",value:t.date_range.end||"",onChange:a=>C("end",a.target.value),InputLabelProps:{shrink:!0},size:"small",sx:{minWidth:150}})]})})})]})},rn=({customers:t,onEdit:i,onDelete:d,onViewDetails:_,loading:P})=>{const u=Q(),v=U(u.breakpoints.down("md")),[g,k]=V.useState(null),[c,I]=V.useState(null),E=(n,m)=>{k(n.currentTarget),I(m)},b=()=>{k(null),I(null)},C=n=>{switch(n){case"active":return"success";case"inactive":return"warning";case"blocked":return"error";default:return"default"}},L=n=>{switch(n){case"active":return"Hoạt động";case"inactive":return"Không hoạt động";case"blocked":return"Bị chặn";default:return"Không xác định"}},D=n=>n>=5e7?{tier:"Bạch kim",color:"#E5E4E2"}:n>=2e7?{tier:"Vàng",color:"#FFD700"}:n>=5e6?{tier:"Bạc",color:"#C0C0C0"}:{tier:"Đồng",color:"#CD7F32"},a=n=>{if(!n)return"";const m=n.replace(/\D/g,"");return m.length===10?`${m.slice(0,4)} ${m.slice(4,7)} ${m.slice(7)}`:n};return v?e.jsx(l,{children:t.map(n=>{const m=D(n.total_spent);return e.jsx(ge,{sx:{mb:2},children:e.jsx(me,{children:e.jsxs(w,{spacing:2,children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ae,{src:n.avatar_url,sx:{width:48,height:48,bgcolor:n.customer_type==="business"?"primary.main":"secondary.main"},children:n.customer_type==="business"?e.jsx(q,{}):e.jsx(G,{})}),e.jsxs(l,{children:[e.jsx(r,{variant:"subtitle1",fontWeight:"bold",children:n.name}),e.jsx(r,{variant:"body2",color:"text.secondary",children:n.customer_type==="business"?"Doanh nghiệp":"Cá nhân"})]})]}),e.jsx(re,{onClick:T=>E(T,n),size:"small",children:e.jsx(ue,{})})]}),e.jsxs(w,{spacing:1,children:[n.phone&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ye,{fontSize:"small",color:"action"}),e.jsx(r,{variant:"body2",children:a(n.phone)})]}),n.email&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Je,{fontSize:"small",color:"action"}),e.jsx(r,{variant:"body2",children:n.email})]}),n.city&&e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(en,{fontSize:"small",color:"action"}),e.jsx(r,{variant:"body2",children:n.city})]})]}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2},children:[e.jsxs(l,{children:[e.jsx(r,{variant:"body2",color:"text.secondary",children:"Tổng chi tiêu"}),e.jsx(r,{variant:"body1",fontWeight:"bold",children:X(n.total_spent)})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"body2",color:"text.secondary",children:"Số đơn hàng"}),e.jsx(r,{variant:"body1",fontWeight:"bold",children:n.total_orders})]})]}),e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(z,{label:L(n.status),color:C(n.status),size:"small"}),e.jsx(z,{icon:e.jsx(N,{}),label:m.tier,size:"small",sx:{bgcolor:m.color,color:"white",fontWeight:"bold"}})]}),e.jsxs(w,{direction:"row",spacing:1,children:[e.jsx(j,{size:"small",variant:"outlined",onClick:()=>_(n),fullWidth:!0,children:"Xem chi tiết"}),e.jsx(j,{size:"small",variant:"contained",onClick:()=>i(n),fullWidth:!0,children:"Chỉnh sửa"})]})]})})},n.id)})}):e.jsxs(e.Fragment,{children:[e.jsx(Se,{component:We,children:e.jsxs(ze,{children:[e.jsx(De,{children:e.jsxs(le,{children:[e.jsx(h,{children:"Khách hàng"}),e.jsx(h,{children:"Liên hệ"}),e.jsx(h,{children:"Loại"}),e.jsx(h,{align:"right",children:"Tổng chi tiêu"}),e.jsx(h,{align:"center",children:"Đơn hàng"}),e.jsx(h,{align:"center",children:"Điểm thưởng"}),e.jsx(h,{align:"center",children:"Hạng"}),e.jsx(h,{align:"center",children:"Trạng thái"}),e.jsx(h,{align:"center",children:"Thao tác"})]})}),e.jsx(Pe,{children:t.map(n=>{const m=D(n.total_spent);return e.jsxs(le,{hover:!0,children:[e.jsx(h,{children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ae,{src:n.avatar_url,sx:{width:40,height:40,bgcolor:n.customer_type==="business"?"primary.main":"secondary.main"},children:n.customer_type==="business"?e.jsx(q,{}):e.jsx(G,{})}),e.jsxs(l,{children:[e.jsx(r,{variant:"body2",fontWeight:"medium",children:n.name}),n.company_name&&e.jsx(r,{variant:"caption",color:"text.secondary",children:n.company_name})]})]})}),e.jsx(h,{children:e.jsxs(l,{children:[e.jsx(r,{variant:"body2",children:a(n.phone)}),e.jsx(r,{variant:"caption",color:"text.secondary",children:n.email})]})}),e.jsx(h,{children:e.jsx(z,{icon:n.customer_type==="business"?e.jsx(q,{}):e.jsx(G,{}),label:n.customer_type==="business"?"Doanh nghiệp":"Cá nhân",size:"small",variant:"outlined"})}),e.jsx(h,{align:"right",children:e.jsx(r,{variant:"body2",fontWeight:"medium",children:X(n.total_spent)})}),e.jsx(h,{align:"center",children:e.jsx(r,{variant:"body2",children:n.total_orders})}),e.jsx(h,{align:"center",children:e.jsx(r,{variant:"body2",color:"primary",children:n.loyalty_points.toLocaleString()})}),e.jsx(h,{align:"center",children:e.jsx(z,{icon:e.jsx(N,{}),label:m.tier,size:"small",sx:{bgcolor:m.color,color:"white",fontWeight:"bold"}})}),e.jsx(h,{align:"center",children:e.jsx(z,{label:L(n.status),color:C(n.status),size:"small"})}),e.jsx(h,{align:"center",children:e.jsx(re,{onClick:T=>E(T,n),size:"small",children:e.jsx(ue,{})})})]},n.id)})})]})}),e.jsxs(Ee,{anchorEl:g,open:!!g,onClose:b,children:[e.jsx(o,{onClick:()=>{c&&_(c),b()},children:e.jsx(r,{children:"Xem chi tiết"})}),e.jsxs(o,{onClick:()=>{c&&i(c),b()},children:[e.jsx(nn,{sx:{mr:1}}),"Chỉnh sửa"]}),e.jsxs(o,{onClick:()=>{c&&d(c.id),b()},sx:{color:"error.main"},children:[e.jsx(sn,{sx:{mr:1}}),"Xóa"]})]})]})},mn=()=>{const t=Re(),{enqueueSnackbar:i}=Ae(),[d,_]=p.useState({search:"",customer_type:"all",status:"all",city:"",loyalty_tier:"all",date_range:{}}),[P,u]=p.useState(null),[v,g]=p.useState([]),[k,c]=p.useState(0),[I,E]=p.useState(25),[b,C]=p.useState(!1),[L,D]=p.useState(null),[a,n]=p.useState(!1),[m,T]=p.useState(!1),[Z,Y]=p.useState(null),[x,H]=p.useState({name:"",email:"",phone:"",customer_type:"individual"}),{data:J,loading:K,error:ee,refetch:O,totalCount:je}=Me("/customers",{page:k+1,limit:I,search:d.search,customer_type:d.customer_type!=="all"?d.customer_type:void 0,status:d.status!=="all"?d.status:void 0,city:d.city||void 0,loyalty_tier:d.loyalty_tier!=="all"?d.loyalty_tier:void 0,date_from:d.date_range.start,date_to:d.date_range.end});p.useEffect(()=>{A(),ne()},[]);const A=async()=>{try{const s=await B.get("/customers/stats");u(s)}catch(s){console.error("Stats fetch error:",s)}},ne=async()=>{try{const s=await B.get("/customers/cities");g(s||[])}catch(s){console.error("Cities fetch error:",s)}},pe=()=>{H({name:"",email:"",phone:"",customer_type:"individual"}),n(!0)},ye=s=>{Y(s),H({name:s.name,email:s.email,phone:s.phone,address:s.address,city:s.city,customer_type:s.customer_type,company_name:s.company_name,notes:s.notes}),T(!0)},ve=async s=>{if(window.confirm("Bạn có chắc chắn muốn xóa khách hàng này?"))try{C(!0),await B.delete(`/customers/${s}`),i("Đã xóa khách hàng",{variant:"success"}),O(),A()}catch(W){i("Lỗi khi xóa khách hàng",{variant:"error"}),console.error("Delete customer error:",W)}finally{C(!1)}},be=s=>{t(`/customers/${s.id}`)},se=async()=>{try{C(!0),Z?(await B.put(`/customers/${Z.id}`,x),i("Đã cập nhật thông tin khách hàng",{variant:"success"}),T(!1)):(await B.post("/customers",x),i("Đã thêm khách hàng mới",{variant:"success"}),n(!1)),O(),A(),Y(null)}catch(s){i("Lỗi khi lưu thông tin khách hàng",{variant:"error"}),console.error("Save customer error:",s)}finally{C(!1)}},Ce=()=>{i("Chức năng nhập Excel sẽ được triển khai sớm",{variant:"info"})},fe=()=>{i("Chức năng xuất dữ liệu sẽ được triển khai sớm",{variant:"info"})},te=()=>{O(),A(),ne()},_e=()=>{_({search:"",customer_type:"all",status:"all",city:"",loyalty_tier:"all",date_range:{}}),c(0)},ke=(s,W)=>{c(W)},Ie=s=>{E(parseInt(s.target.value,10)),c(0)},S=(s,W)=>{H(M=>({...M,[s]:W}))};return L||ee?e.jsxs(ie,{maxWidth:"xl",sx:{py:3},children:[e.jsx(Le,{severity:"error",sx:{mb:2},children:L||ee}),e.jsx(j,{onClick:te,variant:"contained",children:"Thử lại"})]}):e.jsxs(ie,{maxWidth:"xl",sx:{py:3},"data-testid":"customers-list",children:[e.jsx(tn,{stats:P,onAddCustomer:pe,onImport:Ce,onExport:fe,onRefresh:te,loading:b||K}),e.jsx(Be,{sx:{my:3}}),e.jsx(an,{filters:d,onFiltersChange:_,cities:v,onClearFilters:_e}),K&&e.jsx(l,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx($e,{})}),!K&&J&&e.jsxs(e.Fragment,{children:[e.jsx(rn,{customers:J,onEdit:ye,onDelete:ve,onViewDetails:be,loading:b}),e.jsx(Fe,{component:"div",count:je||0,page:k,onPageChange:ke,rowsPerPage:I,onRowsPerPageChange:Ie,rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:"Số dòng mỗi trang:",labelDisplayedRows:({from:s,to:W,count:M})=>`${s}-${W} của ${M!==-1?M:`hơn ${W}`}`})]}),e.jsxs(oe,{open:a,onClose:()=>n(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ce,{children:"Thêm khách hàng mới"}),e.jsx(he,{children:e.jsxs(y,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsx(f,{label:"Tên khách hàng *",value:x.name,onChange:s=>S("name",s.target.value),fullWidth:!0,required:!0})}),e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsxs($,{fullWidth:!0,children:[e.jsx(F,{children:"Loại khách hàng *"}),e.jsxs(R,{value:x.customer_type,onChange:s=>S("customer_type",s.target.value),label:"Loại khách hàng *",children:[e.jsx(o,{value:"individual",children:"Cá nhân"}),e.jsx(o,{value:"business",children:"Doanh nghiệp"})]})]})}),e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsx(f,{label:"Số điện thoại *",value:x.phone,onChange:s=>S("phone",s.target.value),fullWidth:!0,required:!0})}),e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsx(f,{label:"Email",type:"email",value:x.email,onChange:s=>S("email",s.target.value),fullWidth:!0})}),x.customer_type==="business"&&e.jsx(y,{item:!0,xs:12,children:e.jsx(f,{label:"Tên công ty",value:x.company_name||"",onChange:s=>S("company_name",s.target.value),fullWidth:!0})}),e.jsx(y,{item:!0,xs:12,children:e.jsx(f,{label:"Địa chỉ",value:x.address||"",onChange:s=>S("address",s.target.value),fullWidth:!0,multiline:!0,rows:2})}),e.jsx(y,{item:!0,xs:12,children:e.jsx(f,{label:"Ghi chú",value:x.notes||"",onChange:s=>S("notes",s.target.value),fullWidth:!0,multiline:!0,rows:3})})]})}),e.jsxs(de,{children:[e.jsx(j,{onClick:()=>n(!1),children:"Hủy"}),e.jsx(j,{onClick:se,variant:"contained",disabled:b||!x.name||!x.phone,children:"Thêm khách hàng"})]})]}),e.jsxs(oe,{open:m,onClose:()=>T(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ce,{children:"Chỉnh sửa thông tin khách hàng"}),e.jsx(he,{children:e.jsx(y,{container:!0,spacing:2,sx:{mt:1},children:e.jsx(y,{item:!0,xs:12,sm:6,children:e.jsx(f,{label:"Tên khách hàng *",value:x.name,onChange:s=>S("name",s.target.value),fullWidth:!0,required:!0})})})}),e.jsxs(de,{children:[e.jsx(j,{onClick:()=>T(!1),children:"Hủy"}),e.jsx(j,{onClick:se,variant:"contained",disabled:b||!x.name||!x.phone,children:"Cập nhật"})]})]})]})};export{mn as default};
