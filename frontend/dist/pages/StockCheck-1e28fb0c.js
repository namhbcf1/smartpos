import{e as z,p as q,j as e,W as o,$ as v,t as _,T as i,C as D,E as C,A as oe,ak as $,al as B,am as M,ab as k,P as E,V as F,I as G,ap as le,aq as de,ar as he,as as K,at as d,au as ue,af as Q,ae as U,a3 as xe,ad as pe,ax as je,aM as me,D as ge,ay as ye,o as be,v as ke}from"../chunks/mui-core-cd9e8750.js";import{u as ve,r as x}from"../chunks/react-vendor-9ee90314.js";import{a as fe}from"../chunks/ui-vendor-11834b8a.js";import{u as Ce}from"../chunks/useApiData-60d9f817.js";import{a as I}from"../assets/index-fad1ea34.js";import{$ as _e,al as Se,t as we,a0 as Ie,e as Te,U as Pe,_ as H,a as De,W as ze,T as qe}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/utils-vendor-8faa4a85.js";import"../chunks/query-vendor-0e167262.js";const We=({session:t,onBack:p,onSave:j,onRefresh:h,loading:u})=>{const g=z(),n=q(g.breakpoints.down("sm")),y=s=>{switch(s){case"completed":return"success";case"in_progress":return"warning";case"cancelled":return"error";default:return"default"}},r=s=>{switch(s){case"completed":return"Hoàn thành";case"in_progress":return"Đang kiểm";case"cancelled":return"Đã hủy";default:return"Chưa xác định"}};return e.jsxs(o,{sx:{mb:3},children:[e.jsxs(v,{direction:n?"column":"row",justifyContent:"space-between",alignItems:n?"stretch":"center",spacing:2,children:[e.jsxs(v,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(_,{startIcon:e.jsx(_e,{}),onClick:p,variant:"outlined",size:n?"small":"medium",children:"Quay lại"}),e.jsxs(o,{children:[e.jsxs(i,{variant:"h4",component:"h1",gutterBottom:!0,children:[e.jsx(Se,{sx:{mr:1,verticalAlign:"middle"}}),"Kiểm kho"]}),t&&e.jsxs(v,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Phiên: ",t.session_name]}),e.jsx(D,{label:r(t.status),color:y(t.status),size:"small"})]})]})]}),e.jsxs(v,{direction:"row",spacing:1,children:[e.jsx(_,{startIcon:e.jsx(we,{}),onClick:h,variant:"outlined",disabled:u,size:n?"small":"medium",children:"Làm mới"}),e.jsx(_,{startIcon:e.jsx(Ie,{}),onClick:j,variant:"contained",disabled:u||!t,size:n?"small":"medium",children:"Lưu kiểm kho"})]})]}),t&&e.jsx(o,{sx:{mt:2,p:2,bgcolor:"background.paper",borderRadius:2},children:e.jsxs(v,{direction:"row",spacing:4,children:[e.jsxs(o,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Tổng sản phẩm"}),e.jsx(i,{variant:"h6",children:t.total_items})]}),e.jsxs(o,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Đã kiểm"}),e.jsx(i,{variant:"h6",color:"primary",children:t.items_checked})]}),e.jsxs(o,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Sai lệch"}),e.jsx(i,{variant:"h6",color:"error",children:t.discrepancies_found})]}),e.jsxs(o,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Tiến độ"}),e.jsxs(i,{variant:"h6",color:"success.main",children:[t.total_items>0?Math.round(t.items_checked/t.total_items*100):0,"%"]})]})]})})]})},Le=({filters:t,onFiltersChange:p,categories:j})=>{const h=z(),u=q(h.breakpoints.down("sm")),g=r=>{p({...t,search:r.target.value})},n=r=>{p({...t,category:r.target.value})},y=r=>{p({...t,status:r.target.value})};return e.jsx(o,{sx:{mb:3},children:e.jsxs(v,{direction:u?"column":"row",spacing:2,alignItems:u?"stretch":"center",children:[e.jsx(C,{placeholder:"Tìm kiếm sản phẩm...",value:t.search,onChange:g,InputProps:{startAdornment:e.jsx(oe,{position:"start",children:e.jsx(Te,{})})},sx:{flexGrow:1,minWidth:u?"auto":300},size:"small"}),e.jsxs($,{size:"small",sx:{minWidth:150},children:[e.jsx(B,{children:"Danh mục"}),e.jsxs(M,{value:t.category,onChange:n,label:"Danh mục",children:[e.jsx(k,{value:"",children:"Tất cả"}),j.map(r=>e.jsx(k,{value:r,children:r},r))]})]}),e.jsxs($,{size:"small",sx:{minWidth:150},children:[e.jsx(B,{children:"Trạng thái"}),e.jsxs(M,{value:t.status,onChange:y,label:"Trạng thái",startAdornment:e.jsx(Pe,{sx:{mr:1}}),children:[e.jsx(k,{value:"all",children:"Tất cả"}),e.jsx(k,{value:"accurate",children:"Chính xác"}),e.jsx(k,{value:"discrepancy",children:"Sai lệch"}),e.jsx(k,{value:"unchecked",children:"Chưa kiểm"})]})]})]})})},Ae=({items:t,onItemUpdate:p,onItemDelete:j,loading:h})=>{const u=z(),g=q(u.breakpoints.down("md")),n=s=>s===0?{icon:e.jsx(De,{color:"success"}),label:"Chính xác",color:"success"}:{icon:e.jsx(ze,{color:"error"}),label:`Lệch ${s>0?"+":""}${s}`,color:"error"},y=(s,l)=>{const m=parseInt(l)||0;p(s,"actual_quantity",m)},r=(s,l)=>{p(s,"notes",l)};return g?e.jsx(o,{children:t.map(s=>{const l=n(s.discrepancy);return e.jsxs(E,{sx:{p:2,mb:2},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsxs(o,{sx:{flexGrow:1},children:[e.jsx(i,{variant:"subtitle1",fontWeight:"bold",children:s.product_name}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:["SKU: ",s.product_sku]})]}),e.jsx(D,{icon:l.icon,label:l.label,color:l.color,size:"small"})]}),e.jsxs(o,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,mb:2},children:[e.jsxs(o,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Dự kiến"}),e.jsx(i,{variant:"body1",fontWeight:"bold",children:s.expected_quantity})]}),e.jsxs(o,{children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"Thực tế"}),e.jsx(C,{type:"number",value:s.actual_quantity,onChange:m=>y(s.product_id,m.target.value),size:"small",fullWidth:!0,disabled:h})]})]}),e.jsx(C,{placeholder:"Ghi chú...",value:s.notes||"",onChange:m=>r(s.product_id,m.target.value),size:"small",fullWidth:!0,multiline:!0,rows:2,disabled:h,sx:{mb:1}}),e.jsx(o,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(F,{title:"Xóa",children:e.jsx(G,{onClick:()=>j(s.product_id),color:"error",size:"small",disabled:h,children:e.jsx(H,{})})})})]},s.product_id)})}):e.jsx(le,{component:E,children:e.jsxs(de,{children:[e.jsx(he,{children:e.jsxs(K,{children:[e.jsx(d,{children:"Sản phẩm"}),e.jsx(d,{children:"SKU"}),e.jsx(d,{align:"center",children:"Dự kiến"}),e.jsx(d,{align:"center",children:"Thực tế"}),e.jsx(d,{align:"center",children:"Sai lệch"}),e.jsx(d,{children:"Ghi chú"}),e.jsx(d,{align:"center",children:"Thao tác"})]})}),e.jsx(ue,{children:t.map(s=>{const l=n(s.discrepancy);return e.jsxs(K,{children:[e.jsx(d,{children:e.jsx(i,{variant:"body2",fontWeight:"medium",children:s.product_name})}),e.jsx(d,{children:e.jsx(i,{variant:"body2",color:"text.secondary",children:s.product_sku})}),e.jsx(d,{align:"center",children:e.jsx(i,{variant:"body2",children:s.expected_quantity})}),e.jsx(d,{align:"center",children:e.jsx(C,{type:"number",value:s.actual_quantity,onChange:m=>y(s.product_id,m.target.value),size:"small",sx:{width:80},disabled:h})}),e.jsx(d,{align:"center",children:e.jsx(D,{icon:l.icon,label:l.label,color:l.color,size:"small"})}),e.jsx(d,{children:e.jsx(C,{placeholder:"Ghi chú...",value:s.notes||"",onChange:m=>r(s.product_id,m.target.value),size:"small",sx:{minWidth:150},disabled:h})}),e.jsx(d,{align:"center",children:e.jsx(F,{title:"Xóa",children:e.jsx(G,{onClick:()=>j(s.product_id),color:"error",size:"small",disabled:h,children:e.jsx(H,{})})})})]},s.product_id)})})]})})},Ne=()=>{const t=ve(),{enqueueSnackbar:p}=fe(),[j,h]=x.useState(null),[u,g]=x.useState([]),[n,y]=x.useState({search:"",category:"",status:"all"}),[r,s]=x.useState(!1),[l,m]=x.useState(null),[S,W]=x.useState(0),[f,N]=x.useState(25),[O,V]=x.useState([]),[X,T]=x.useState(!1);x.useState([]);const{data:Re,loading:$e,error:Be,refetch:J}=Ce("/products",{page:S+1,limit:f,search:n.search,category:n.category});x.useEffect(()=>{L(),Y()},[]);const L=async()=>{try{s(!0);const a=await I.get("/inventory/stock-check/active");if(a)h(a),g(a.items||[]);else{const c=await I.post("/inventory/stock-check",{session_name:`Kiểm kho ${new Date().toLocaleDateString("vi-VN")}`,status:"in_progress"});h(c)}}catch(a){m("Không thể khởi tạo phiên kiểm kho"),console.error("Stock check initialization error:",a)}finally{s(!1)}},Y=async()=>{try{const a=await I.get("/categories/names");V(a||[])}catch(a){console.error("Categories fetch error:",a)}},Z=()=>{t("/inventory")},ee=async()=>{if(j)try{s(!0);const a={...j,items:u,items_checked:u.filter(c=>c.actual_quantity!==c.expected_quantity||c.actual_quantity===c.expected_quantity).length,discrepancies_found:u.filter(c=>c.discrepancy!==0).length};await I.put(`/inventory/stock-check/${j.id}`,a),p("Đã lưu kết quả kiểm kho",{variant:"success"})}catch(a){p("Lỗi khi lưu kiểm kho",{variant:"error"}),console.error("Save stock check error:",a)}finally{s(!1)}},A=()=>{J(),L()},se=x.useCallback((a,c,b)=>{g(ie=>ie.map(P=>{if(P.product_id===a){const w={...P,[c]:b};return c==="actual_quantity"&&(w.discrepancy=w.actual_quantity-w.expected_quantity),w}return P}))},[]),ae=x.useCallback(a=>{g(c=>c.filter(b=>b.product_id!==a))},[]),te=()=>{T(!0)},R=u.filter(a=>{if(n.search&&!a.product_name.toLowerCase().includes(n.search.toLowerCase())&&!a.product_sku.toLowerCase().includes(n.search.toLowerCase()))return!1;if(n.status!=="all")switch(n.status){case"accurate":return a.discrepancy===0;case"discrepancy":return a.discrepancy!==0;case"unchecked":return a.actual_quantity===0;default:return!0}return!0}),ne=R.slice(S*f,S*f+f),re=(a,c)=>{W(c)},ce=a=>{N(parseInt(a.target.value,10)),W(0)};return l?e.jsxs(Q,{maxWidth:"xl",sx:{py:3},children:[e.jsx(U,{severity:"error",sx:{mb:2},children:l}),e.jsx(_,{onClick:A,variant:"contained",children:"Thử lại"})]}):e.jsxs(Q,{maxWidth:"xl",sx:{py:3},children:[e.jsx(We,{session:j,onBack:Z,onSave:ee,onRefresh:A,loading:r}),e.jsx(xe,{sx:{my:3}}),e.jsx(Le,{filters:n,onFiltersChange:y,categories:O}),r&&e.jsx(o,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(pe,{})}),!r&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{items:ne,onItemUpdate:se,onItemDelete:ae,loading:r}),e.jsx(je,{component:"div",count:R.length,page:S,onPageChange:re,rowsPerPage:f,onRowsPerPageChange:ce,rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:"Số dòng mỗi trang:",labelDisplayedRows:({from:a,to:c,count:b})=>`${a}-${c} của ${b!==-1?b:`hơn ${c}`}`})]}),e.jsx(me,{color:"primary","aria-label":"add",sx:{position:"fixed",bottom:16,right:16},onClick:te,children:e.jsx(qe,{})}),e.jsxs(ge,{open:X,onClose:()=>T(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ye,{children:"Thêm sản phẩm vào kiểm kho"}),e.jsx(be,{children:e.jsx(o,{sx:{p:2},children:e.jsx(U,{severity:"info",children:"Chức năng chọn sản phẩm sẽ được triển khai trong phiên bản tiếp theo"})})}),e.jsx(ke,{children:e.jsx(_,{onClick:()=>T(!1),children:"Đóng"})})]})]})};export{Ne as default};
