import{j as e,af as X,T as s,W as l,t as p,Y,Z,aj as c,E as m,A as J,ak as W,al as F,am as z,ab as i,V as v,I as y,ae as A,ag as ee,ap as te,P as ne,aq as se,ar as re,as as b,at as n,au as ae,ax as ie,D as le,ay as oe,o as ce,a3 as he,v as de,C as d}from"../chunks/mui-core-cd9e8750.js";import{u as xe,r as h,L as ue}from"../chunks/react-vendor-9ee90314.js";import{u as je}from"../chunks/useApiData-60d9f817.js";import{a as ge}from"../chunks/ui-vendor-11834b8a.js";import{b as C}from"../assets/index-fad1ea34.js";import{a6 as pe,T as me,e as ve,t as B,U as ye,w as be,Z as fe,al as Ce,Y as Se,a as Te,Q as we}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/utils-vendor-8faa4a85.js";import"../chunks/query-vendor-0e167262.js";const Fe=()=>{const E=xe(),{enqueueSnackbar:S}=ge(),[x,T]=h.useState(""),[u,w]=h.useState(""),[j,_]=h.useState(""),[g,P]=h.useState(""),[r,o]=h.useState({open:!1,returnItem:null,newStatus:"",notes:""}),$=h.useMemo(()=>{const t={};return x.trim()&&(t.search=x.trim()),u&&(t.return_status=u),j&&(t.date_from=j),g&&(t.date_to=g),t},[x,u,j,g]),{data:k,pagination:I,isLoading:H,error:D,refetch:f,handlePageChange:N,handleLimitChange:U,page:V,limit:R}=je("/returns",$),G=()=>{console.log("🔄 Returns: Retrying data fetch..."),f()},q=t=>{switch(t){case"pending":return e.jsx(d,{icon:e.jsx(we,{}),label:"Chờ duyệt",color:"warning",size:"small"});case"approved":return e.jsx(d,{icon:e.jsx(Te,{}),label:"Đã duyệt",color:"success",size:"small"});case"rejected":return e.jsx(d,{icon:e.jsx(Se,{}),label:"Từ chối",color:"error",size:"small"});case"completed":return e.jsx(d,{icon:e.jsx(Ce,{}),label:"Hoàn thành",color:"info",size:"small"});default:return e.jsx(d,{label:t,size:"small"})}},K=t=>{E(`/returns/${t}`)},Q=t=>{o({open:!0,returnItem:t,newStatus:t.return_status,notes:t.notes||""})},M=async()=>{if(r.returnItem)try{const t=await fetch(`/api/v1/returns/${r.returnItem.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({return_status:r.newStatus,notes:r.notes})});if(!t.ok){const a=await t.json();throw new Error(a.message||"Lỗi khi cập nhật trạng thái")}S("Cập nhật trạng thái thành công",{variant:"success"}),o({open:!1,returnItem:null,newStatus:"",notes:""}),f()}catch(t){console.error("Update status error:",t),S(t instanceof Error?t.message:"Lỗi khi cập nhật trạng thái",{variant:"error"})}},O=()=>{T(""),w(""),_(""),P("")};return e.jsxs(X,{maxWidth:"xl",sx:{py:3},children:[e.jsxs(s,{variant:"h4",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(pe,{}),"Trả hàng & Hoàn tiền"]}),e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(s,{variant:"h6",color:"text.secondary",children:"Quản lý trả hàng và hoàn tiền"}),e.jsx(p,{variant:"contained",startIcon:e.jsx(me,{}),component:ue,to:"/returns/new",children:"Tạo phiếu trả hàng"})]}),e.jsx(Y,{sx:{mb:3},children:e.jsx(Z,{children:e.jsxs(c,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(c,{item:!0,xs:12,md:3,children:e.jsx(m,{fullWidth:!0,label:"Tìm kiếm",placeholder:"Lý do trả hàng, tên khách hàng...",value:x,onChange:t=>T(t.target.value),InputProps:{startAdornment:e.jsx(J,{position:"start",children:e.jsx(ve,{})})}})}),e.jsx(c,{item:!0,xs:12,md:2,children:e.jsxs(W,{fullWidth:!0,children:[e.jsx(F,{children:"Trạng thái"}),e.jsxs(z,{value:u,label:"Trạng thái",onChange:t=>w(t.target.value),children:[e.jsx(i,{value:"",children:"Tất cả"}),e.jsx(i,{value:"pending",children:"Chờ duyệt"}),e.jsx(i,{value:"approved",children:"Đã duyệt"}),e.jsx(i,{value:"rejected",children:"Từ chối"}),e.jsx(i,{value:"completed",children:"Hoàn thành"})]})]})}),e.jsx(c,{item:!0,xs:12,md:2,children:e.jsx(m,{fullWidth:!0,type:"date",label:"Từ ngày",value:j,onChange:t=>_(t.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(c,{item:!0,xs:12,md:2,children:e.jsx(m,{fullWidth:!0,type:"date",label:"Đến ngày",value:g,onChange:t=>P(t.target.value),InputLabelProps:{shrink:!0}})}),e.jsx(c,{item:!0,xs:12,md:3,children:e.jsxs(l,{sx:{display:"flex",gap:1},children:[e.jsx(v,{title:"Làm mới",children:e.jsx(y,{onClick:f,children:e.jsx(B,{})})}),e.jsx(v,{title:"Xóa bộ lọc",children:e.jsx(y,{onClick:O,children:e.jsx(ye,{})})})]})})]})})}),D&&e.jsxs(A,{severity:"error",sx:{mb:2},action:e.jsx(p,{color:"inherit",size:"small",onClick:G,startIcon:e.jsx(B,{}),children:"Thử lại"}),children:[e.jsx(ee,{children:"Lỗi tải dữ liệu"}),D]}),e.jsxs(te,{component:ne,children:[e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(b,{children:[e.jsx(n,{children:"ID"}),e.jsx(n,{children:"Đơn hàng gốc"}),e.jsx(n,{children:"Khách hàng"}),e.jsx(n,{align:"right",children:"Số tiền trả"}),e.jsx(n,{children:"Lý do"}),e.jsx(n,{children:"Trạng thái"}),e.jsx(n,{children:"Ngày tạo"}),e.jsx(n,{align:"center",children:"Thao tác"})]})}),e.jsx(ae,{children:H?Array.from({length:R}).map((t,a)=>e.jsx(b,{children:e.jsx(n,{colSpan:8,children:e.jsx(l,{sx:{display:"flex",alignItems:"center",gap:2},children:e.jsx(l,{sx:{width:"100%",height:40,bgcolor:"grey.200",borderRadius:1}})})})},a)):k.length>0?k.map(t=>e.jsxs(b,{hover:!0,children:[e.jsxs(n,{children:["#",t.id]}),e.jsxs(n,{children:[e.jsxs(s,{variant:"body2",fontWeight:500,children:["#",t.original_sale_id]}),t.original_amount&&e.jsxs(s,{variant:"caption",color:"text.secondary",children:["Gốc: ",C(t.original_amount)]})]}),e.jsx(n,{children:e.jsxs(l,{children:[e.jsx(s,{variant:"body2",fontWeight:500,children:t.customer_name||"Khách vãng lai"}),t.customer_phone&&e.jsx(s,{variant:"caption",color:"text.secondary",children:t.customer_phone})]})}),e.jsx(n,{align:"right",children:e.jsx(s,{variant:"body2",fontWeight:600,color:"error.main",children:C(t.return_amount)})}),e.jsxs(n,{children:[e.jsx(s,{variant:"body2",children:t.return_reason}),t.notes&&e.jsx(s,{variant:"caption",color:"text.secondary",children:t.notes})]}),e.jsx(n,{children:q(t.return_status)}),e.jsxs(n,{children:[e.jsx(s,{variant:"body2",children:new Date(t.created_at).toLocaleDateString("vi-VN")}),e.jsx(s,{variant:"caption",color:"text.secondary",children:new Date(t.created_at).toLocaleTimeString("vi-VN")})]}),e.jsx(n,{align:"center",children:e.jsxs(l,{sx:{display:"flex",gap:.5},children:[e.jsx(v,{title:"Xem chi tiết",children:e.jsx(y,{size:"small",onClick:()=>K(t.id),children:e.jsx(be,{})})}),t.return_status!=="completed"&&e.jsx(v,{title:"Cập nhật trạng thái",children:e.jsx(y,{size:"small",onClick:()=>Q(t),children:e.jsx(fe,{})})})]})})]},t.id)):e.jsx(b,{children:e.jsx(n,{colSpan:8,align:"center",children:e.jsx(A,{severity:"info",sx:{border:"none"},children:e.jsx(s,{children:"Không tìm thấy phiếu trả hàng nào."})})})})})]}),I&&e.jsx(ie,{component:"div",count:I.total,page:V-1,onPageChange:(t,a)=>N(a+1),rowsPerPage:R,onRowsPerPageChange:t=>U(parseInt(t.target.value)),rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:"Số dòng mỗi trang:",labelDisplayedRows:({from:t,to:a,count:L})=>`${t}-${a} của ${L!==-1?L:`hơn ${a}`}`})]}),e.jsxs(le,{open:r.open,onClose:()=>o({open:!1,returnItem:null,newStatus:"",notes:""}),maxWidth:"sm",fullWidth:!0,children:[e.jsx(oe,{children:"Cập nhật trạng thái trả hàng"}),e.jsx(ce,{children:r.returnItem&&e.jsxs(l,{sx:{mt:2},children:[e.jsxs(s,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Phiếu trả hàng:"})," #",r.returnItem.id]}),e.jsxs(s,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Đơn hàng gốc:"})," #",r.returnItem.original_sale_id]}),e.jsxs(s,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Số tiền trả:"})," ",C(r.returnItem.return_amount)]}),e.jsx(he,{sx:{my:2}}),e.jsxs(W,{fullWidth:!0,margin:"normal",children:[e.jsx(F,{children:"Trạng thái"}),e.jsxs(z,{value:r.newStatus,label:"Trạng thái",onChange:t=>o(a=>({...a,newStatus:t.target.value})),children:[e.jsx(i,{value:"pending",children:"Chờ duyệt"}),e.jsx(i,{value:"approved",children:"Đã duyệt"}),e.jsx(i,{value:"rejected",children:"Từ chối"}),e.jsx(i,{value:"completed",children:"Hoàn thành"})]})]}),e.jsx(m,{fullWidth:!0,label:"Ghi chú",value:r.notes,onChange:t=>o(a=>({...a,notes:t.target.value})),margin:"normal",multiline:!0,rows:3,placeholder:"Ghi chú về việc cập nhật trạng thái..."})]})}),e.jsxs(de,{children:[e.jsx(p,{onClick:()=>o({open:!1,returnItem:null,newStatus:"",notes:""}),children:"Hủy"}),e.jsx(p,{variant:"contained",onClick:M,disabled:!r.newStatus,children:"Cập nhật"})]})]})]})};export{Fe as default};
