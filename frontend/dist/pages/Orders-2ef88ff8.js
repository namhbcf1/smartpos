import{e as Te,p as Se,j as e,af as _e,P as v,$ as b,W as a,T as t,t as x,aj as l,Y as C,Z as T,E as X,ak as k,al as D,am as z,ab as c,ap as Y,aq as J,ar as ee,as as u,at as s,au as ne,ad as te,C as O,V as B,I as L,ax as we,D as se,ay as re,o as ae,a3 as S,v as ie}from"../chunks/mui-core-cd9e8750.js";import{r as o}from"../chunks/react-vendor-9ee90314.js";import{a as Ie}from"../chunks/ui-vendor-11834b8a.js";import{b as h,a as R}from"../assets/index-fad1ea34.js";import{u as We}from"../chunks/useApiData-60d9f817.js";import{al as N,t as Pe,am as ke,ag as De,an as le,e as ze,U as Oe,a3 as Be,ao as Le,w as ce,Z as oe,_ as Re}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/query-vendor-0e167262.js";import"../chunks/utils-vendor-8faa4a85.js";const qe=()=>{const he=Te();Se(he.breakpoints.down("md"));const{enqueueSnackbar:j}=Ie(),[m,E]=o.useState(""),[g,F]=o.useState(""),[p,M]=o.useState(""),[r,$]=o.useState(null),[de,_]=o.useState(!1),[xe,y]=o.useState(!1),[w,I]=o.useState(""),[A,H]=o.useState(""),[K,V]=o.useState(!1),ue=o.useMemo(()=>{const n={};return m.trim()&&(n.search=m.trim()),p&&(n.payment_method=p),g&&(n.payment_status=g),n},[m,p,g]),{data:d,pagination:W,isLoading:q,error:Ne,refetch:P,handlePageChange:je,handleLimitChange:me,page:ge,limit:pe}=We("/sales",ue),f=o.useMemo(()=>!d||d.length===0?{totalOrders:0,totalRevenue:0,pendingOrders:0,completedOrders:0}:{totalOrders:W?.total||0,totalRevenue:d.reduce((n,i)=>n+(i.total_amount||0),0),pendingOrders:d.filter(n=>n.payment_status==="pending").length,completedOrders:d.filter(n=>n.payment_status==="paid").length},[d,W]),ye=async n=>{try{const i=await R.get(`/sales/${n}`);i.success&&($(i.data),_(!0))}catch(i){console.error("Error fetching order details:",i),j("Lỗi khi tải chi tiết đơn hàng",{variant:"error"})}},fe=async()=>{if(r)try{V(!0),(await R.put(`/sales/${r.order.id}/status`,{payment_status:w,notes:A})).success&&(j("Cập nhật trạng thái đơn hàng thành công",{variant:"success"}),y(!1),I(""),H(""),P())}catch(n){console.error("Error updating order status:",n),j("Lỗi khi cập nhật trạng thái đơn hàng",{variant:"error"})}finally{V(!1)}},ve=async n=>{if(window.confirm("Bạn có chắc chắn muốn hủy đơn hàng này?"))try{(await R.delete(`/sales/${n}`)).success&&(j("Hủy đơn hàng thành công",{variant:"success"}),P())}catch(i){console.error("Error deleting order:",i),j("Lỗi khi hủy đơn hàng",{variant:"error"})}},G=n=>{switch(n){case"paid":return"success";case"pending":return"warning";case"cancelled":return"error";default:return"default"}},U=n=>{switch(n){case"paid":return"Đã thanh toán";case"pending":return"Chờ thanh toán";case"cancelled":return"Đã hủy";default:return n}},Z=n=>{switch(n){case"cash":return"Tiền mặt";case"card":return"Thẻ";case"bank_transfer":return"Chuyển khoản";default:return n}},be=n=>{E(n.target.value)},Ce=()=>{E(""),F(""),M("")};return e.jsxs(_e,{maxWidth:"xl",sx:{py:{xs:1,sm:2},px:{xs:1,sm:2,md:3},minHeight:"100vh",bgcolor:"grey.50"},children:[e.jsx(v,{elevation:1,sx:{p:{xs:2,sm:3},mb:3,borderRadius:2,bgcolor:"white"},children:e.jsxs(b,{direction:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",sm:"center"},spacing:2,children:[e.jsxs(a,{children:[e.jsxs(t,{variant:"h4",sx:{display:"flex",alignItems:"center",gap:1,fontSize:{xs:"1.5rem",sm:"2rem",md:"2.125rem"},fontWeight:600,color:"primary.main",mb:1},children:[e.jsx(N,{sx:{fontSize:"inherit"}}),"Quản lý đơn hàng"]}),e.jsx(t,{variant:"body1",color:"text.secondary",sx:{fontSize:{xs:"0.875rem",sm:"1rem"}},children:"Theo dõi và quản lý tất cả đơn hàng"})]}),e.jsxs(b,{direction:"row",spacing:1,children:[e.jsx(x,{variant:"outlined",startIcon:e.jsx(Pe,{}),onClick:P,disabled:q,children:"Làm mới"}),e.jsx(x,{variant:"outlined",startIcon:e.jsx(ke,{}),children:"Xuất dữ liệu"})]})]})}),e.jsxs(l,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(C,{children:e.jsx(T,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,variant:"body2",children:"Tổng đơn hàng"}),e.jsx(t,{variant:"h5",component:"div",children:f.totalOrders})]}),e.jsx(N,{color:"primary",sx:{fontSize:40}})]})})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(C,{children:e.jsx(T,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,variant:"body2",children:"Tổng doanh thu"}),e.jsx(t,{variant:"h5",component:"div",children:h(f.totalRevenue)})]}),e.jsx(De,{color:"success",sx:{fontSize:40}})]})})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(C,{children:e.jsx(T,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,variant:"body2",children:"Chờ thanh toán"}),e.jsx(t,{variant:"h5",component:"div",children:f.pendingOrders})]}),e.jsx(le,{color:"warning",sx:{fontSize:40}})]})})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(C,{children:e.jsx(T,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(a,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,variant:"body2",children:"Đã hoàn thành"}),e.jsx(t,{variant:"h5",component:"div",children:f.completedOrders})]}),e.jsx(N,{color:"success",sx:{fontSize:40}})]})})})})]}),e.jsx(v,{elevation:1,sx:{p:{xs:2,sm:3},mb:3,borderRadius:2},children:e.jsxs(l,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(l,{item:!0,xs:12,md:4,children:e.jsx(X,{fullWidth:!0,placeholder:"Tìm kiếm theo tên khách hàng, số điện thoại...",value:m,onChange:be,InputProps:{startAdornment:e.jsx(ze,{sx:{mr:1,color:"text.secondary"}})}})}),e.jsx(l,{item:!0,xs:12,sm:6,md:2,children:e.jsxs(k,{fullWidth:!0,children:[e.jsx(D,{children:"Trạng thái"}),e.jsxs(z,{value:g,label:"Trạng thái",onChange:n=>F(n.target.value),children:[e.jsx(c,{value:"",children:"Tất cả"}),e.jsx(c,{value:"paid",children:"Đã thanh toán"}),e.jsx(c,{value:"pending",children:"Chờ thanh toán"}),e.jsx(c,{value:"cancelled",children:"Đã hủy"})]})]})}),e.jsx(l,{item:!0,xs:12,sm:6,md:2,children:e.jsxs(k,{fullWidth:!0,children:[e.jsx(D,{children:"Phương thức TT"}),e.jsxs(z,{value:p,label:"Phương thức TT",onChange:n=>M(n.target.value),children:[e.jsx(c,{value:"",children:"Tất cả"}),e.jsx(c,{value:"cash",children:"Tiền mặt"}),e.jsx(c,{value:"card",children:"Thẻ"}),e.jsx(c,{value:"bank_transfer",children:"Chuyển khoản"})]})]})}),e.jsx(l,{item:!0,xs:12,md:4,children:e.jsx(b,{direction:"row",spacing:1,children:e.jsx(x,{variant:"outlined",startIcon:e.jsx(Oe,{}),onClick:Ce,children:"Xóa bộ lọc"})})})]})}),e.jsxs(v,{elevation:1,sx:{borderRadius:2,overflow:"hidden"},children:[e.jsx(Y,{children:e.jsxs(J,{children:[e.jsx(ee,{children:e.jsxs(u,{sx:{bgcolor:"grey.50"},children:[e.jsx(s,{sx:{fontWeight:600},children:"ID"}),e.jsx(s,{sx:{fontWeight:600},children:"Khách hàng"}),e.jsx(s,{sx:{fontWeight:600},children:"Số điện thoại"}),e.jsx(s,{sx:{fontWeight:600},children:"Tổng tiền"}),e.jsx(s,{sx:{fontWeight:600},children:"Phương thức TT"}),e.jsx(s,{sx:{fontWeight:600},children:"Trạng thái"}),e.jsx(s,{sx:{fontWeight:600},children:"Người bán"}),e.jsx(s,{sx:{fontWeight:600},children:"Ngày tạo"}),e.jsx(s,{sx:{fontWeight:600},children:"Thao tác"})]})}),e.jsx(ne,{children:q?e.jsx(u,{children:e.jsx(s,{colSpan:9,sx:{textAlign:"center",py:4},children:e.jsx(te,{})})}):d.length===0?e.jsx(u,{children:e.jsx(s,{colSpan:9,sx:{textAlign:"center",py:4},children:e.jsx(t,{color:"text.secondary",children:"Không tìm thấy đơn hàng nào"})})}):d.map(n=>e.jsxs(u,{hover:!0,children:[e.jsxs(s,{children:["#",n.id]}),e.jsx(s,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Be,{sx:{fontSize:16,color:"text.secondary"}}),n.customer_name||"Khách vãng lai"]})}),e.jsx(s,{children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Le,{sx:{fontSize:16,color:"text.secondary"}}),n.customer_phone||"-"]})}),e.jsxs(s,{children:[e.jsx(t,{variant:"body2",sx:{fontWeight:600},children:h(n.total_amount)}),n.discount_amount>0&&e.jsxs(t,{variant:"caption",color:"text.secondary",children:["(Giảm: ",h(n.discount_amount),")"]})]}),e.jsx(s,{children:e.jsx(O,{label:Z(n.payment_method),size:"small",variant:"outlined"})}),e.jsx(s,{children:e.jsx(O,{label:U(n.payment_status),size:"small",color:G(n.payment_status)})}),e.jsxs(s,{children:[e.jsx(t,{variant:"body2",sx:{fontWeight:500},children:n.cashier_name||"Không xác định"}),n.cashier_username&&e.jsxs(t,{variant:"caption",color:"text.secondary",children:["@",n.cashier_username]})]}),e.jsxs(s,{children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(le,{sx:{fontSize:16,color:"text.secondary"}}),new Date(n.created_at).toLocaleDateString("vi-VN",{timeZone:"Asia/Ho_Chi_Minh"})]}),e.jsx(t,{variant:"caption",color:"text.secondary",children:new Date(n.created_at).toLocaleTimeString("vi-VN",{timeZone:"Asia/Ho_Chi_Minh"})})]}),e.jsx(s,{children:e.jsxs(b,{direction:"row",spacing:1,children:[e.jsx(B,{title:"Xem chi tiết",children:e.jsx(L,{size:"small",onClick:()=>ye(n.id),children:e.jsx(ce,{})})}),e.jsx(B,{title:"Cập nhật trạng thái",children:e.jsx(L,{size:"small",onClick:()=>{$({order:n,items:[]}),I(n.payment_status),y(!0)},children:e.jsx(oe,{})})}),e.jsx(B,{title:"Hủy đơn hàng",children:e.jsx(L,{size:"small",onClick:()=>ve(n.id),color:"error",children:e.jsx(Re,{})})})]})})]},n.id))})]})}),e.jsx(we,{component:"div",count:W?.total||0,page:ge-1,onPageChange:(n,i)=>je(i+1),rowsPerPage:pe,onRowsPerPageChange:n=>me(parseInt(n.target.value,10)),labelRowsPerPage:"Số hàng mỗi trang:",labelDisplayedRows:({from:n,to:i,count:Q})=>`${n}-${i} của ${Q!==-1?Q:`hơn ${i}`}`})]}),e.jsxs(se,{open:de,onClose:()=>_(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(re,{children:e.jsxs(t,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ce,{}),"Chi tiết đơn hàng #",r?.order.id]})}),e.jsx(ae,{children:r&&e.jsxs(a,{children:[e.jsxs(l,{container:!0,spacing:2,sx:{mb:3},children:[e.jsxs(l,{item:!0,xs:12,md:6,children:[e.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"Thông tin khách hàng"}),e.jsxs(a,{sx:{pl:2},children:[e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Tên:"})," ",r.order.customer_name||"Khách vãng lai"]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Số điện thoại:"})," ",r.order.customer_phone||"-"]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Email:"})," ",r.order.customer_email||"-"]})]})]}),e.jsxs(l,{item:!0,xs:12,md:6,children:[e.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"Thông tin thanh toán"}),e.jsxs(a,{sx:{pl:2},children:[e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Phương thức:"})," ",Z(r.order.payment_method)]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Trạng thái:"}),e.jsx(O,{label:U(r.order.payment_status),size:"small",color:G(r.order.payment_status),sx:{ml:1}})]}),e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:"Ngày tạo:"})," ",new Date(r.order.created_at).toLocaleString("vi-VN")]})]})]})]}),e.jsx(S,{sx:{my:2}}),e.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"Sản phẩm trong đơn hàng"}),e.jsx(Y,{component:v,variant:"outlined",children:e.jsxs(J,{size:"small",children:[e.jsx(ee,{children:e.jsxs(u,{children:[e.jsx(s,{children:"Sản phẩm"}),e.jsx(s,{children:"SKU"}),e.jsx(s,{align:"right",children:"Số lượng"}),e.jsx(s,{align:"right",children:"Đơn giá"}),e.jsx(s,{align:"right",children:"Thành tiền"})]})}),e.jsx(ne,{children:r.items.map(n=>e.jsxs(u,{children:[e.jsxs(s,{children:[e.jsx(t,{variant:"body2",sx:{fontWeight:500},children:n.product_name}),e.jsx(t,{variant:"caption",color:"text.secondary",children:n.category_name})]}),e.jsx(s,{children:n.product_sku}),e.jsx(s,{align:"right",children:n.quantity}),e.jsx(s,{align:"right",children:h(n.unit_price)}),e.jsx(s,{align:"right",children:h(n.total_price)})]},n.id))})]})}),e.jsx(S,{sx:{my:2}}),e.jsx(a,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsxs(a,{sx:{minWidth:200},children:[e.jsxs(t,{variant:"body2",sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Tạm tính:"}),e.jsx("span",{children:h(r.order.total_amount-r.order.tax_amount+r.order.discount_amount)})]}),r.order.discount_amount>0&&e.jsxs(t,{variant:"body2",sx:{display:"flex",justifyContent:"space-between",color:"error.main"},children:[e.jsx("span",{children:"Giảm giá:"}),e.jsxs("span",{children:["-",h(r.order.discount_amount)]})]}),e.jsxs(t,{variant:"body2",sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Thuế VAT:"}),e.jsx("span",{children:h(r.order.tax_amount)})]}),e.jsx(S,{sx:{my:1}}),e.jsxs(t,{variant:"h6",sx:{display:"flex",justifyContent:"space-between",fontWeight:600},children:[e.jsx("span",{children:"Tổng cộng:"}),e.jsx("span",{children:h(r.order.total_amount)})]})]})}),r.order.notes&&e.jsxs(e.Fragment,{children:[e.jsx(S,{sx:{my:2}}),e.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"Ghi chú"}),e.jsx(t,{variant:"body2",sx:{pl:2},children:r.order.notes})]})]})}),e.jsx(ie,{children:e.jsx(x,{onClick:()=>_(!1),children:"Đóng"})})]}),e.jsxs(se,{open:xe,onClose:()=>y(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(re,{children:e.jsxs(t,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(oe,{}),"Cập nhật trạng thái đơn hàng #",r?.order.id]})}),e.jsx(ae,{children:e.jsxs(a,{sx:{pt:2},children:[e.jsxs(k,{fullWidth:!0,sx:{mb:2},children:[e.jsx(D,{children:"Trạng thái thanh toán"}),e.jsxs(z,{value:w,label:"Trạng thái thanh toán",onChange:n=>I(n.target.value),children:[e.jsx(c,{value:"paid",children:"Đã thanh toán"}),e.jsx(c,{value:"pending",children:"Chờ thanh toán"}),e.jsx(c,{value:"cancelled",children:"Đã hủy"})]})]}),e.jsx(X,{fullWidth:!0,label:"Ghi chú (tùy chọn)",multiline:!0,rows:3,value:A,onChange:n=>H(n.target.value),placeholder:"Nhập ghi chú về việc cập nhật trạng thái..."})]})}),e.jsxs(ie,{children:[e.jsx(x,{onClick:()=>y(!1),children:"Hủy"}),e.jsx(x,{onClick:fe,variant:"contained",disabled:K||!w,startIcon:K?e.jsx(te,{size:16}):null,children:"Cập nhật"})]})]})]})};export{qe as default};
