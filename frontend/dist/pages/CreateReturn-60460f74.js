import{j as e,af as K,W as i,I as O,T as a,aj as d,Y as v,Z as b,t as c,ae as F,ak as k,al as I,am as R,ab as D,E,a3 as H,D as z,ay as Q,o as Y,ap as Z,P as U,aq as $,ar as J,as as W,at as r,au as X,v as ee}from"../chunks/mui-core-cd9e8750.js";import{u as ne,r as s}from"../chunks/react-vendor-9ee90314.js";import{a as te}from"../chunks/ui-vendor-11834b8a.js";import{b as f}from"../assets/index-fad1ea34.js";import{$ as ae,e as re,a0 as se,Y as le}from"../chunks/mui-icons-f0327ae6.js";import"../chunks/query-vendor-0e167262.js";import"../chunks/utils-vendor-8faa4a85.js";const ie=[{value:"DEFECTIVE",label:"Sản phẩm lỗi"},{value:"WRONG_ITEM",label:"Giao sai sản phẩm"},{value:"NOT_AS_DESC",label:"Không đúng mô tả"},{value:"CHANGE_MIND",label:"Khách hàng đổi ý"},{value:"DAMAGED",label:"Sản phẩm bị hỏng"},{value:"OTHER",label:"Lý do khác"}],ce=[{value:"cash",label:"Tiền mặt"},{value:"card",label:"Thẻ"},{value:"transfer",label:"Chuyển khoản"},{value:"store_credit",label:"Tín dụng cửa hàng"},{value:"exchange",label:"Đổi hàng"}];function je(){const x=ne(),{enqueueSnackbar:o}=te(),[l,A]=s.useState(null),[m,L]=s.useState([]),[g,B]=s.useState(""),[_,N]=s.useState("cash"),[y,P]=s.useState(""),[j,u]=s.useState(!1),[q,h]=s.useState(!1),[S,w]=s.useState(""),[C,G]=s.useState([]),p=m.reduce((n,t)=>n+t.total_amount,0),T=async()=>{if(S.trim())try{u(!0),G([{id:1,sale_number:"SAL-2024-001",customer_name:"Nguyễn Văn A",customer_phone:"0123456789",total_amount:15e5,created_at:"2024-01-15T10:30:00Z",items:[{id:1,product_id:1,product_name:"iPhone 15 Pro",product_sku:"IP15P-256-BLU",quantity:1,unit_price:15e5,total_amount:15e5}]}])}catch{o("Lỗi khi tìm kiếm đơn hàng",{variant:"error"})}finally{u(!1)}},M=n=>{A(n),L(n.items.map(t=>({sale_item_id:t.id,product_id:t.product_id,product_name:t.product_name,product_sku:t.product_sku,quantity_original:t.quantity,quantity_returned:0,unit_price:t.unit_price,total_amount:0,return_reason:"",condition:"used",restockable:!0,notes:""}))),h(!1)},V=async()=>{if(!l){o("Vui lòng chọn đơn hàng",{variant:"error"});return}const n=m.filter(t=>t.quantity_returned>0);if(n.length===0){o("Vui lòng chọn ít nhất một sản phẩm để trả",{variant:"error"});return}if(!g){o("Vui lòng chọn lý do trả hàng",{variant:"error"});return}try{u(!0);const t={original_sale_id:l.id,return_reason:g,refund_method:_,return_amount:p,notes:y,items:n};console.log("Creating return:",t),o("Tạo phiếu trả hàng thành công!",{variant:"success"}),x("/returns")}catch{o("Lỗi khi tạo phiếu trả hàng",{variant:"error"})}finally{u(!1)}};return e.jsx(K,{maxWidth:"lg",children:e.jsxs(i,{sx:{py:3},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(O,{onClick:()=>x("/returns"),sx:{mr:2},children:e.jsx(ae,{})}),e.jsx(a,{variant:"h4",component:"h1",sx:{flexGrow:1},children:"Tạo phiếu trả hàng"})]}),e.jsxs(d,{container:!0,spacing:3,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(v,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Chọn đơn hàng gốc"}),l?e.jsxs(i,{children:[e.jsxs(F,{severity:"info",sx:{mb:2},children:[e.jsxs(a,{variant:"subtitle2",children:["Đơn hàng: ",l.sale_number]}),e.jsxs(a,{variant:"body2",children:["Khách hàng: ",l.customer_name," - ",l.customer_phone]}),e.jsxs(a,{variant:"body2",children:["Tổng tiền: ",f(l.total_amount)]})]}),e.jsx(c,{variant:"outlined",size:"small",onClick:()=>h(!0),children:"Chọn đơn hàng khác"})]}):e.jsx(c,{variant:"outlined",startIcon:e.jsx(re,{}),onClick:()=>h(!0),fullWidth:!0,sx:{py:2},children:"Tìm kiếm đơn hàng"})]})})}),l&&e.jsxs(e.Fragment,{children:[e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(v,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Thông tin trả hàng"}),e.jsxs(k,{fullWidth:!0,sx:{mb:2},children:[e.jsx(I,{children:"Lý do trả hàng"}),e.jsx(R,{value:g,onChange:n=>B(n.target.value),label:"Lý do trả hàng",children:ie.map(n=>e.jsx(D,{value:n.value,children:n.label},n.value))})]}),e.jsxs(k,{fullWidth:!0,sx:{mb:2},children:[e.jsx(I,{children:"Phương thức hoàn tiền"}),e.jsx(R,{value:_,onChange:n=>N(n.target.value),label:"Phương thức hoàn tiền",children:ce.map(n=>e.jsx(D,{value:n.value,children:n.label},n.value))})]}),e.jsx(E,{fullWidth:!0,label:"Ghi chú",multiline:!0,rows:3,value:y,onChange:n=>P(n.target.value)})]})})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(v,{children:e.jsxs(b,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Tổng kết"}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsx(a,{children:"Số sản phẩm trả:"}),e.jsx(a,{children:m.filter(n=>n.quantity_returned>0).length})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsx(a,{variant:"h6",children:"Tổng tiền hoàn:"}),e.jsx(a,{variant:"h6",color:"primary",children:f(p)})]}),e.jsx(H,{sx:{my:2}}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(c,{variant:"contained",startIcon:e.jsx(se,{}),onClick:V,disabled:j||p===0,fullWidth:!0,children:"Tạo phiếu trả hàng"}),e.jsx(c,{variant:"outlined",startIcon:e.jsx(le,{}),onClick:()=>x("/returns"),disabled:j,children:"Hủy"})]})]})})})]})]}),e.jsxs(z,{open:q,onClose:()=>h(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Q,{children:"Tìm kiếm đơn hàng"}),e.jsxs(Y,{children:[e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,mt:1},children:[e.jsx(E,{fullWidth:!0,label:"Số đơn hàng hoặc tên khách hàng",value:S,onChange:n=>w(n.target.value),onKeyPress:n=>n.key==="Enter"&&T()}),e.jsx(c,{variant:"contained",onClick:T,disabled:j,children:"Tìm kiếm"})]}),C.length>0&&e.jsx(Z,{component:U,children:e.jsxs($,{children:[e.jsx(J,{children:e.jsxs(W,{children:[e.jsx(r,{children:"Số đơn hàng"}),e.jsx(r,{children:"Khách hàng"}),e.jsx(r,{children:"Tổng tiền"}),e.jsx(r,{children:"Ngày tạo"}),e.jsx(r,{children:"Thao tác"})]})}),e.jsx(X,{children:C.map(n=>e.jsxs(W,{children:[e.jsx(r,{children:n.sale_number}),e.jsx(r,{children:n.customer_name}),e.jsx(r,{children:f(n.total_amount)}),e.jsx(r,{children:new Date(n.created_at).toLocaleDateString("vi-VN")}),e.jsx(r,{children:e.jsx(c,{size:"small",onClick:()=>M(n),children:"Chọn"})})]},n.id))})]})})]}),e.jsx(ee,{children:e.jsx(c,{onClick:()=>h(!1),children:"Đóng"})})]})]})})}export{je as default};
